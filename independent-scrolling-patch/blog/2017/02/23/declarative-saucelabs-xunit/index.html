<!DOCTYPE html>
<html lang="en">
<head>
<title>
Browser testing and conditional logic in Declarative Pipeline
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="description">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2017/02/23/declarative-saucelabs-xunit/" rel="canonical">
<!-- Favicons -->
<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="/site.webmanifest" rel="manifest">
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon">
<meta content="#2b5797" name="msapplication-TileColor">
<meta content="#ffffff" name="theme-color">
<meta content="Browser testing and conditional logic in Declarative Pipeline" name="apple-mobile-web-app-title">
<!-- Twitter Card data -->
<meta content="summary_large_image" name="twitter:card">
<meta content="@JenkinsCI" name="twitter:site">
<meta content="Browser testing and conditional logic in Declarative Pipeline" name="twitter:title">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="twitter:description">
<meta content="@JenkinsCI" name="twitter:creator">
<!-- Twitter Summary card images must be at least 120x120px -->
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="twitter:image">
<!-- Open Graph data -->
<meta content="Browser testing and conditional logic in Declarative Pipeline" property="og:title">
<meta content="article" property="og:type">
<meta content="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2017/02/23/declarative-saucelabs-xunit/" property="og:url">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="og:description">
<meta content="Browser testing and conditional logic in Declarative Pipeline" property="og:site_name">
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="og:image">
<link href="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/jenkins.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/stylesheets/styles.css" media="screen" rel="stylesheet">
<!-- Non-obtrusive CSS styles -->
<link href="/jenkins.io/independent-scrolling-patch/css/footer.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/font-awesome.min.css" media="screen" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" rel="stylesheet">
</head>
<body>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/jquery/jquery.min.js"></script>
<!-- starting partial toptoolbar.html.haml -->
<jio-navbar class="fixed-top" id="ji-toolbar" property="https://www.jenkins.io" showSearchBox=""></jio-navbar>
<!-- Spacing to make the fixed-top sticky navbar not occlude any content below it -->
<div class="pt-4">
&nbsp;
</div>

<!-- ending partial toptoolbar.html.haml -->
<!-- starting partial anchors.html.haml -->
<script>
  window.addEventListener('DOMContentLoaded', function () {
    for (var i = 1 ; i <= 6 ; i ++) {
      anchors.add('.app-post-page h' + i);
    }
  })
</script>

<!-- ending partial anchors.html.haml -->
<article class="container app-post-page">
<div class="app-!-display-flex">
<a class="app-back-link" href="/jenkins.io/independent-scrolling-patch/node/">
Back to blog
</a>
</div>
<h1>
Browser testing and conditional logic in Declarative Pipeline
</h1>
<div class="post-attrs">
<a class="app-author-link" href="/blog/authors/lnewman/"><div class="app-avatar"><img alt="Liam Newman" class="app-avatar__image" src="/images/avatars/lnewman.jpeg"></div> Liam Newman</a>
February 23, 2017
<a class="twitter-share-button" data-lang="en" href="https://twitter.com/intent/tweet?text=Browser+testing+and+conditional+logic+in+Declarative+Pipeline&amp;url=https%3A%2F%2Fwww.jenkins.io%2Fjenkins.io%2Findependent-scrolling-patch%2Fblog%2F2017%2F02%2F23%2Fdeclarative-saucelabs-xunit%2F" rel="noreferrer nofollow" target="_blank">
Tweet
</a>
</div>
<div class="blog-content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a guest post by <a href="https://github.com/bitwiseman">Liam Newman</a>,
Technical Evangelist at <a href="https://cloudbees.com">CloudBees</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Declare Your Pipelines!</strong>
<a href="/blog/2017/02/03/declarative-pipeline-ga/">Declarative Pipeline 1.0 is here</a>!
This is the fourth post in a series showing some of the cool features of
<a href="/doc/book/pipeline/syntax/#declarative-pipeline">Declarative Pipeline</a>.</p>
</div>
<div class="paragraph">
<p>In the
<a href="/blog/2017/02/15/declarative-notifications/">previous post</a>,
we integrated several notification services into a Declarative Pipeline.
We kept our Pipeline clean and easy to understand
by using a shared library to make a custom step called <code>sendNotifications</code>
that we called at the start and end of our Pipeline.</p>
</div>
<div class="paragraph">
<p>In this blog post, we&#8217;ll start by translating the Scripted Pipeline in the sample project I worked with
in
"<a href="/blog/2016/08/29/sauce-pipeline/">Browser-testing with Sauce OnDemand and Pipeline</a>"
and
"<a href="/blog/2016/10/31/xunit-reporting/">xUnit and Pipeline</a>"
to Declarative.
We&#8217;ll make our Pipeline clearer by adding an <code>environment</code> directive
to define some environment variables, and then moving some code to a shared library.
Finally, we&#8217;ll look at using the <code>when</code> directive to add simple conditional behavior to our Pipeline.</p>
</div>
<div class="sect1">
<h2 id="setup"><a class="anchor" href="#setup"></a>Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The setup for this post uses the same repository as the two posts above,
<a href="https://github.com/bitwiseman/JS-Nightwatch.js">my fork</a>
of the
<a href="https://github.com/saucelabs-sample-test-frameworks/JS-Nightwatch.js">JS-Nightwatch.js sample project</a>.
I&#8217;ve once again created a branch specifically for this blog post,
this time called
<a href="https://github.com/bitwiseman/JS-Nightwatch.js/tree/blog/declarative/sauce"><code>blog/declarative/sauce</code></a>.</p>
</div>
<div class="paragraph">
<p>Like the two posts above, this Pipeline will use the
<a href="https://plugins.jenkins.io/xunit">xUnit</a> and
<a href="https://plugins.jenkins.io/sauce-ondemand">Sauce OnDemand</a> plugins.
The xUnit plugin only needs to be installed, the Sauce OnDemand needs additional configuration.
Follow
<a href="https://wiki.saucelabs.com/display/DOCS/Installing+and+Configuring+the+Sauce+OnDemand+Plugin+for+Jenkins">Sauce Labs' configuration instructions</a>
to create an account with Sauce Labs and add your Sauce Labs credentials to Jenkins.
The Sauce OnDemand plugin will automatically install
<a href="https://wiki.saucelabs.com/display/DOCS/Sauce+Connect+Proxy">Sauce Connect</a>
for us when we call it from our Pipeline.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Be sure to you have the latest version of the
<a href="https://plugins.jenkins.io/sauce-ondemand">Sauce OnDemand</a> plugin (1.160 or newer).
It has several fixes required for this post.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For a shared library, I&#8217;ve still got the one from the
<a href="/blog/2017/02/15/declarative-notifications/">previous post</a>.
To set up this "Global Pipeline Library," navigate to "Manage Jenkins" &#8594; "Configure System"
in the Jenkins web UI.
Once there, under "Global Pipeline Libraries", add a new library.
Then set the name to <code>bitwiseman-shared</code>, point it at my repository,
and set the default branch for the library to <code>master</code>.</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2017-02-15/shared-library.png" alt="Global Pipeline Library" width="800">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reducing-complexity-with-declarative"><a class="anchor" href="#reducing-complexity-with-declarative"></a>Reducing Complexity with Declarative</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you&#8217;ve been following along through this series,
this first step will be quite familiar by now.
We&#8217;ll start from the Pipeline we had at the end of the xUnit post
and translate it to Declarative.</p>
</div>
<div class="pipeline-block">  <div class="listingblock pipeline-declarative">
    <div class="title">Jenkinsfile (Declarative Pipeline)</div>
    <div class="content">
  <pre class="CodeRay highlight nowrap"><code class="language-groovy" data-lang="groovy">pipeline {
    agent any
    options {
        <span style="color:#777">// Nightwatch.js supports color output, so wrap add his option</span>
        ansiColor <span style="color:#606">colorMapName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">XTerm</span><span style="color:#710">'</span></span>
    }
    stages {
        stage (<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Build</span><span style="color:#710">&quot;</span></span>) {
            steps {
                <span style="color:#777">// Install dependencies</span>
                sh <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">npm install</span><span style="color:#710">'</span></span>
            }
        }
        stage (<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Test</span><span style="color:#710">&quot;</span></span>) {
            steps {
                <span style="color:#777">// Add sauce credentials</span>
                sauce(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">f0a6b8ad-ce30-4cba-bf9a-95afbc470a8a</span><span style="color:#710">'</span></span>) {
                    <span style="color:#777">// Start sauce connect</span>
                    sauceconnect() {
                        <span style="color:#777">// Run selenium tests using Nightwatch.js</span>
                        <span style="color:#777">// Ignore error codes. The junit publisher will cover setting build status.</span>
                        sh <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">./node_modules/.bin/nightwatch -e chrome,firefox,ie,edge --test tests/guineaPig.js || true</span><span style="color:#710">&quot;</span></span>
                    }
                }
            }
            post {
                always {
                    step([<span style="color:#F00;background-color:#FAA">$</span><span style="color:#339;font-weight:bold">class</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">XUnitBuilder</span><span style="color:#710">'</span></span>,
                        <span style="color:#B06;font-weight:bold">thresholds</span>: [
                            [<span style="color:#F00;background-color:#FAA">$</span><span style="color:#339;font-weight:bold">class</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">SkippedThreshold</span><span style="color:#710">'</span></span>, <span style="color:#B06;font-weight:bold">failureThreshold</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">0</span><span style="color:#710">'</span></span>],
                            <span style="color:#777">// Allow for a significant number of failures</span>
                            <span style="color:#777">// Keeping this threshold so that overwhelming failures are guaranteed</span>
                            <span style="color:#777">//     to still fail the build</span>
                            [<span style="color:#F00;background-color:#FAA">$</span><span style="color:#339;font-weight:bold">class</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">FailedThreshold</span><span style="color:#710">'</span></span>, <span style="color:#B06;font-weight:bold">failureThreshold</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">10</span><span style="color:#710">'</span></span>]],
                        <span style="color:#606">tools</span>: [[<span style="color:#F00;background-color:#FAA">$</span><span style="color:#339;font-weight:bold">class</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">JUnitType</span><span style="color:#710">'</span></span>, <span style="color:#B06;font-weight:bold">pattern</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">reports/**</span><span style="color:#710">'</span></span>]]])

                    saucePublisher()
                }
            }
        }
    }</code></pre>
</div></div>  <div class="pipeline-script-expand">
    <a href="#" onclick="javascript:$(this).parent().siblings('.pipeline-script').toggle(); return false;">Toggle Scripted Pipeline</a>
    <em>(Advanced)</em>
  </div>
  <div class="listingblock pipeline-script"
        style="display: none">
    <div class="title">Jenkinsfile (Scripted Pipeline)</div>
    <div class="content">
  <pre class="CodeRay highlight nowrap"><code class="language-groovy" data-lang="groovy">node {
    stage <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Build</span><span style="color:#710">&quot;</span></span>
    checkout scm

    <span style="color:#777">// Install dependencies</span>
    sh <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">npm install</span><span style="color:#710">'</span></span>

    stage <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Test</span><span style="color:#710">&quot;</span></span>
    <span style="color:#777">// Add sauce credentials</span>
    sauce(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">f0a6b8ad-ce30-4cba-bf9a-95afbc470a8a</span><span style="color:#710">'</span></span>) {
        <span style="color:#777">// Start sauce connect</span>
        sauceconnect() {

            <span style="color:#777">// List of browser configs we'll be testing against.</span>
            <span style="color:#080;font-weight:bold">def</span> platform_configs = [
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">chrome</span><span style="color:#710">'</span></span>,
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">firefox</span><span style="color:#710">'</span></span>,
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">ie</span><span style="color:#710">'</span></span>,
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">edge</span><span style="color:#710">'</span></span>
            ].join(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">,</span><span style="color:#710">'</span></span>)

            <span style="color:#777">// Nightwatch.js supports color output, so wrap this step for ansi color</span>
            wrap([<span style="color:#F00;background-color:#FAA">$</span><span style="color:#339;font-weight:bold">class</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">AnsiColorBuildWrapper</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">colorMapName</span><span style="color:#710">'</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">XTerm</span><span style="color:#710">'</span></span>]) {
                <span style="color:#777">// Run selenium tests using Nightwatch.js</span>
                <span style="color:#777">// Ignore error codes. The junit publisher will cover setting build status.</span>
                sh <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">./node_modules/.bin/nightwatch -e </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">${</span>platform_configs<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> --test tests/guineaPig.js || true</span><span style="color:#710">&quot;</span></span>
            }

            step([<span style="color:#F00;background-color:#FAA">$</span><span style="color:#339;font-weight:bold">class</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">XUnitBuilder</span><span style="color:#710">'</span></span>,
                <span style="color:#B06;font-weight:bold">thresholds</span>: [
                    [<span style="color:#F00;background-color:#FAA">$</span><span style="color:#339;font-weight:bold">class</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">SkippedThreshold</span><span style="color:#710">'</span></span>, <span style="color:#B06;font-weight:bold">failureThreshold</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">0</span><span style="color:#710">'</span></span>],
                    <span style="color:#777">// Allow for a significant number of failures</span>
                    <span style="color:#777">// Keeping this threshold so that overwhelming failures are guaranteed</span>
                    <span style="color:#777">//     to still fail the build</span>
                    [<span style="color:#F00;background-color:#FAA">$</span><span style="color:#339;font-weight:bold">class</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">FailedThreshold</span><span style="color:#710">'</span></span>, <span style="color:#B06;font-weight:bold">failureThreshold</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">10</span><span style="color:#710">'</span></span>]],
                <span style="color:#606">tools</span>: [[<span style="color:#F00;background-color:#FAA">$</span><span style="color:#339;font-weight:bold">class</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">JUnitType</span><span style="color:#710">'</span></span>, <span style="color:#B06;font-weight:bold">pattern</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">reports/**</span><span style="color:#710">'</span></span>]]])

            saucePublisher()
        }
    }
}</code></pre>
</div></div></div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2017-02-23/blue-ocean.png" alt="Blue Ocean Run" width="800">
</div>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2017-02-23/sauce-report.png" alt="SauceLabs Test Report" width="800">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Blue Ocean doesn&#8217;t support displaying SauceLabs test reports yet
(see <a href="https://issues.jenkins.io/browse/JENKINS-42242">JENKINS-42242</a>).
To view the report above, I had to switch back to the stage view of this run.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="elevating-settings-using-environment"><a class="anchor" href="#elevating-settings-using-environment"></a>Elevating Settings using <code>environment</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each time we&#8217;ve moved a project from Scripted Pipeline to Declarative,
we&#8217;ve found the cleaner format of Declarative Pipeline highlights the less
clear parts of the existing Pipeline.
In this case, the first thing that jumps out at me is that the parameters of the
Saucelabs and Nightwatch execution are hardcoded and buried down in the middle of our Pipeline.
This is a relatively short Pipeline, so it isn&#8217;t terribly hard to find them,
but as this pipeline grows and changes it would be better if those values were kept separate.
In Scripted, we&#8217;d have defined some variables,
but Declarative doesn&#8217;t allow us to define variables in the usual Groovy sense.</p>
</div>
<div class="paragraph">
<p>The <code>environment</code> directive let&#8217;s us set some environment variables
and use them later in our pipeline.
As you&#8217;d expect, the <code>environment</code> directive is just a set of name-value pairs.
Environment variables are accessible in Pipeline via <code>env.variableName</code> (or just <code>variableName</code>)
and in shell scripts as standard environment variables, typically <code>$variableName</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s move the list of browsers, the test filter, and the sauce credential string to environment variables.</p>
</div>
<div class="listingblock">
<div class="title">Jenkinsfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy">    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">saucelabsCredentialId</span> <span class="o">=</span> <span class="s1">'f0a6b8ad-ce30-4cba-bf9a-95afbc470a8a'</span>
        <span class="n">sauceTestFilter</span> <span class="o">=</span> <span class="s1">'tests/guineaPig.js'</span>
        <span class="n">platformConfigs</span> <span class="o">=</span> <span class="s1">'chrome,firefox,ie,edge'</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="cm">/* ... unchanged ... */</span>
        <span class="n">stage</span> <span class="o">(</span><span class="s2">"Test"</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="c1">// Add sauce credentials</span>
                <span class="n">sauce</span><span class="o">(</span><span class="n">saucelabsCredentialId</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// Start sauce connect</span>
                    <span class="n">sauceconnect</span><span class="o">()</span> <span class="o">{</span>
                        <span class="c1">// Run selenium tests using Nightwatch.js</span>
                        <span class="c1">// Ignore error codes. The junit publisher will cover setting build status.</span>
                        <span class="n">sh</span> <span class="s2">"./node_modules/.bin/nightwatch -e ${env.platformConfigs} --test ${env.sauceTestFilter} || true"</span> <i class="conum" data-value="1"></i><b>(1)</b>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">post</span> <span class="o">{</span> <span class="cm">/* ... unchanged ... */</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This double-quoted string causes Groovy to replace the variables with their
literal values before passing to <code>sh</code>.
This could also be written using singe-quotes:
<code>sh './node_modules/.bin/nightwatch -e $platformConfigs --test $sauceTestFilter || true'</code>.
With a single quoted string, the string is passed as written to the shell,
and then <strong>the shell</strong> does the variable substitution.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="moving-complex-code-to-shared-libraries"><a class="anchor" href="#moving-complex-code-to-shared-libraries"></a>Moving Complex Code to Shared Libraries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have settings separated from the code, we can do some code clean up.
Unlike the previous post, we don&#8217;t have any repeating code,
but we do have some distractions.
The nesting of <code>sauce</code>, <code>sauceconnect</code>, and <code>sh nightwatch</code> seems excessive,
and that xUnit <code>step</code> is a bit ugly as well.
Let&#8217;s move those into our shared library as custom steps with parameters.
We&#8217;ll change the <code>Jenkinsfile</code> in our main project,
and add the custom steps to a branch named
<code>blog/declarative/sauce</code> in our library repository.</p>
</div>
<div class="listingblock">
<div class="title">Jenkinsfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="nd">@Library</span><span class="o">(</span><span class="s1">'bitwiseman-shared@blog/declarative/sauce'</span><span class="o">)</span> <span class="n">_</span>

<span class="cm">/* ... unchanged ... */</span>

<span class="n">stage</span> <span class="o">(</span><span class="s2">"Test"</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">steps</span> <span class="o">{</span>
        <span class="n">sauceNightwatch</span> <span class="n">saucelabsCredentialId</span><span class="o">,</span>
            <span class="n">platformConfigs</span><span class="o">,</span>
            <span class="n">sauceTestFilter</span>
    <span class="o">}</span>
    <span class="n">post</span> <span class="o">{</span>
        <span class="n">always</span> <span class="o">{</span>
            <span class="n">xUnitPublishResults</span> <span class="s1">'reports/**'</span><span class="o">,</span>
                <span class="cm">/* failWhenSkippedExceeds */</span> <span class="mi">0</span><span class="o">,</span>
                <span class="cm">/* failWhenFailedExceeds */</span> <span class="mi">10</span>

            <span class="n">saucePublisher</span><span class="o">()</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">vars/sauceNightwatch.groovy</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="kt">def</span> <span class="nf">call</span><span class="o">(</span><span class="n">String</span> <span class="n">sauceCredential</span><span class="o">,</span> <span class="n">String</span> <span class="n">platforms</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">String</span> <span class="n">testFilter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">platforms</span> <span class="o">=</span> <span class="n">platforms</span> <span class="o">?</span> <span class="s2">"-e '"</span> <span class="o">+</span> <span class="n">platforms</span> <span class="o">+</span> <span class="s2">"'"</span> <span class="o">:</span> <span class="s1">''</span>
    <span class="n">testFilter</span> <span class="o">=</span> <span class="n">testFilter</span> <span class="o">?</span> <span class="s2">"--test '"</span> <span class="o">+</span> <span class="n">testFilter</span> <span class="o">+</span> <span class="s2">"'"</span> <span class="o">:</span> <span class="s1">''</span>

    <span class="c1">// Add sauce credentials</span>
    <span class="n">sauce</span><span class="o">(</span><span class="n">sauceCredential</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Start sauce connect</span>
        <span class="n">sauceconnect</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// Run selenium tests using Nightwatch.js</span>
            <span class="c1">// Ignore error codes. The junit publisher will cover setting build status.</span>
            <span class="n">sh</span> <span class="s2">"./node_modules/.bin/nightwatch ${platforms} ${testFilter} || true"</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this form, this could not be written using a literal single-quoted string.
Here, <code>platforms</code> and <code>testFilter</code> are groovy variables, not environment variables.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">vars/xUnitPublishResults.groovy</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="kt">def</span> <span class="nf">call</span><span class="o">(</span><span class="n">String</span> <span class="n">pattern</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">failWhenSkippedExceeds</span><span class="o">,</span>
        <span class="n">Integer</span> <span class="n">failWhenFailedExceeds</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">step</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">'XUnitBuilder'</span><span class="o">,</span>
        <span class="nl">thresholds:</span> <span class="o">[</span>
            <span class="o">[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">'SkippedThreshold'</span><span class="o">,</span> <span class="nl">failureThreshold:</span> <span class="n">failWhenSkippedExceeds</span><span class="o">.</span><span class="na">toString</span><span class="o">()],</span>
            <span class="c1">// Allow for a significant number of failures</span>
            <span class="c1">// Keeping this threshold so that overwhelming failures are guaranteed</span>
            <span class="c1">//     to still fail the build</span>
            <span class="o">[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">'FailedThreshold'</span><span class="o">,</span> <span class="nl">failureThreshold:</span> <span class="n">failWhenFailedExceeds</span><span class="o">.</span><span class="na">toString</span><span class="o">()]],</span>
        <span class="nl">tools:</span> <span class="o">[[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">'JUnitType'</span><span class="o">,</span> <span class="nl">pattern:</span> <span class="n">pattern</span><span class="o">]]])</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-conditional-stages-using-when"><a class="anchor" href="#running-conditional-stages-using-when"></a>Running Conditional Stages using <code>when</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is a sample web testing project.
We probably wouldn&#8217;t deploy it like we would production code,
but we might still want to deploy somewhere,
by publishing it to an artifact repository, for example.
This project is hosted on GitHub and uses feature branches and pull requests to make changes.
I&#8217;d like to use the same Pipeline for feature branches, pull requests, and the master branch,
but I only want to deploy from master.</p>
</div>
<div class="paragraph">
<p>In Scripted, we&#8217;d wrap a <code>stage</code> in an <code>if-then</code> and check if the branch for
the current run is named "master".
Declarative doesn&#8217;t support that kind of general conditional behavior.
Instead, it provides a
<a href="/doc/book/pipeline/syntax/#when"><code>when</code> directive</a>
that can be added to <code>stage</code> sections.
The <code>when</code> directive supports several types of conditions, including a <code>branch</code> condition,
where the stage will run when the branch name matches the specified pattern.
That is exactly what we need here.</p>
</div>
<div class="listingblock">
<div class="title">Jenkinsfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">stages</span> <span class="o">{</span>
    <span class="cm">/* ... unchanged ... */</span>
    <span class="n">stage</span> <span class="o">(</span><span class="s1">'Deploy'</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">when</span> <span class="o">{</span>
            <span class="n">branch</span> <span class="s1">'master'</span>
        <span class="o">}</span>
        <span class="n">steps</span> <span class="o">{</span>
             <span class="n">echo</span> <span class="s1">'Placeholder for deploy steps.'</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When we run our Pipeline with this new stage, we get the following outputs:</p>
</div>
<div class="listingblock">
<div class="title">Log output for 'feature/test' branch</div>
<div class="content">
<pre class="rouge highlight nowrap"><code>...
Finished Sauce Labs test publisher
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Deploy)
Stage 'Deploy' skipped due to when conditional
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Log output for 'master' branch</div>
<div class="content">
<pre class="rouge highlight nowrap"><code>...
Finished Sauce Labs test publisher
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Deploy)
[Pipeline] echo
Placeholder for deploy steps.
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I have to say, our latest Declarative Pipeline turned out extremely well.
I think someone coming from Freestyle jobs, with little to no experience with Pipeline or Groovy,
would still be able to look at this Declarative Pipeline and make sense of what it is doing.
We&#8217;ve added new functionality to our Pipeline while making it easier to understand
and maintain.</p>
</div>
<div class="paragraph">
<p>I hope you&#8217;ve learned as much as I have during this blog series.
I&#8217;m excited to see that even in the the short time since Declarative 1.0 was released,
teams are already using it in make improvements similar to what those we&#8217;ve covered in this series.
Thanks for reading!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="links"><a class="anchor" href="#links"></a>Links</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://plugins.jenkins.io/xunit">xUnit</a></p>
</li>
<li>
<p><a href="https://plugins.jenkins.io/sauce-ondemand">Sauce OnDemand</a></p>
</li>
<li>
<p><a href="https://plugins.jenkins.io/pipeline-model-definition">Declarative Pipeline plugin</a></p>
</li>
<li>
<p><a href="/doc/book/pipeline/syntax/#declarative-pipeline">Declarative Pipeline Syntax Reference</a></p>
</li>
<li>
<p><a href="https://github.com/bitwiseman/JS-Nightwatch.js/tree/blog/declarative/sauce">Pipeline source for this post</a></p>
</li>
<li>
<p><a href="https://github.com/bitwiseman/jenkins-pipeline-shared/tree/blog/declarative/sauce">Pipeline Shared Library source for this post</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<ul class="app-tags">
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/pipeline/">
pipeline
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/plugins/">
plugins
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/xunit/">
xunit
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/nightwatch/">
nightwatch
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/saucelabs/">
saucelabs
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/selenium/">
selenium
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/declarative/">
declarative
</a>
</li>
</ul>
<h2>
About the author
</h2>
<!-- starting partial author.html.haml -->
<div class="app-author" id="about-the-author">
<!-- starting partial avatar.html.haml -->
<div class="app-avatar" style="min-width: 64px; width: 25vw; max-width: 128px">
<img alt="Liam Newman" class="app-avatar__image" src="/jenkins.io/independent-scrolling-patch/images/avatars/lnewman.jpeg">
</div>

<!-- ending partial avatar.html.haml -->
<div class="app-author__content">
<p class="app-author__name">
<a href="/blog/authors/lnewman/">
Liam Newman
</a>
</p>
<div class="paragraph">
<p>Liam started his software career as a tester, which might explain why he&#8217;s such a fan of CI/CD and Pipeline as Code.
He has spent the majority of his software engineering career implementing Continuous Integration systems at companies big and small.
He is a Jenkins project contributor and an expert in Jenkins Pipeline, both Scripted and Declarative.
Liam currently works as a Jenkins Evangelist at <a href="https://cloudbees.com">CloudBees</a>.
When not at work, he enjoys testing gravity by doing Aikido.</p>
</div>
<!-- starting partial social-media-buttons.html.haml -->
<ul class="app-social-media-buttons">
<li>
<a href="https://github.com/bitwiseman" rel="noreferrer noopener" target="_blank">
GitHub
</a>
</li>
<li>
<a href="https://twitter.com/bitwiseman" rel="noreferrer noopener" target="_blank">
Twitter
</a>
</li>
</ul>

<!-- ending partial social-media-buttons.html.haml -->
</div>
</div>

<!-- ending partial author.html.haml -->
<!-- starting partial discuss.html.haml -->

<!-- ending partial discuss.html.haml -->
</article>


<script src="/jenkins.io/independent-scrolling-patch/assets/bower/anchor-js/anchor.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/@popperjs/core/umd/popper.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lit@2.5.0/polyfill-support.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.6.0/webcomponents-loader.js"></script>
<script data="ionicons" defer="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.esm.js" type="module"></script>
<script data="ionicons" defer="" nomodule="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/+esm" type="module"></script>
<script defer="" nomodule="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/"></script>
<jio-footer githubBranch="master" githubRepo="jenkins-infra/jenkins.io" property="https://www.jenkins.io" sourcePath="content//blog/2017/02/2017-02-23-declarative-saucelabs-xunit.adoc"></jio-footer>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-000000-0', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  $(function(){
    var $body = $(document.body);
    $body.on("keydown", function(){
      $body.removeClass("no-outline");
    })
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3" type="text/javascript"></script>
<script type="text/javascript">
docsearch({
  container: document.querySelector('input.searchbox').parentNode,
  indexName: 'jenkins',
  appId: "M6L7Q4Z8HS",
  apiKey: "52f8dfbff76ffd9106f1c68fee16154b",
  algoliaOptions: { 'facetFilters': ["tags:en"] },
  debug: false
});
</script>
</body>
</html>
