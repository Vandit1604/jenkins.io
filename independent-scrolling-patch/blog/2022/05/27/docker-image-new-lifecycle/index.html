<!DOCTYPE html>
<html lang="en">
<head>
<title>
Docker Image: new Exit and Restart Behavior for Controllers
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="The restart behavior of the Docker image for Jenkins controllers changed with the weekly 2.344 and the LTS 2.332.3. Container Engine should control this lifecycle (instead of the jenkins process in the container).
" name="description">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2022/05/27/docker-image-new-lifecycle/" rel="canonical">
<!-- Favicons -->
<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="/site.webmanifest" rel="manifest">
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon">
<meta content="#2b5797" name="msapplication-TileColor">
<meta content="#ffffff" name="theme-color">
<meta content="Docker Image: new Exit and Restart Behavior for Controllers" name="apple-mobile-web-app-title">
<!-- Twitter Card data -->
<meta content="summary_large_image" name="twitter:card">
<meta content="@JenkinsCI" name="twitter:site">
<meta content="Docker Image: new Exit and Restart Behavior for Controllers" name="twitter:title">
<meta content="The restart behavior of the Docker image for Jenkins controllers changed with the weekly 2.344 and the LTS 2.332.3. Container Engine should control this lifecycle (instead of the jenkins process in the container).
" name="twitter:description">
<meta content="@JenkinsCI" name="twitter:creator">
<!-- Twitter Summary card images must be at least 120x120px -->
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="twitter:image">
<!-- Open Graph data -->
<meta content="Docker Image: new Exit and Restart Behavior for Controllers" property="og:title">
<meta content="article" property="og:type">
<meta content="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2022/05/27/docker-image-new-lifecycle/" property="og:url">
<meta content="The restart behavior of the Docker image for Jenkins controllers changed with the weekly 2.344 and the LTS 2.332.3. Container Engine should control this lifecycle (instead of the jenkins process in the container).
" name="og:description">
<meta content="Docker Image: new Exit and Restart Behavior for Controllers" property="og:site_name">
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="og:image">
<link href="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/jenkins.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/stylesheets/styles.css" media="screen" rel="stylesheet">
<!-- Non-obtrusive CSS styles -->
<link href="/jenkins.io/independent-scrolling-patch/css/footer.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/font-awesome.min.css" media="screen" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" rel="stylesheet">
</head>
<body>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/jquery/jquery.min.js"></script>
<!-- starting partial toptoolbar.html.haml -->
<jio-navbar class="fixed-top" id="ji-toolbar" property="https://www.jenkins.io" showSearchBox=""></jio-navbar>
<!-- Spacing to make the fixed-top sticky navbar not occlude any content below it -->
<div class="pt-4">
&nbsp;
</div>

<!-- ending partial toptoolbar.html.haml -->
<!-- starting partial anchors.html.haml -->
<script>
  window.addEventListener('DOMContentLoaded', function () {
    for (var i = 1 ; i <= 6 ; i ++) {
      anchors.add('.app-post-page h' + i);
    }
  })
</script>

<!-- ending partial anchors.html.haml -->
<article class="container app-post-page">
<div class="app-!-display-flex">
<a class="app-back-link" href="/jenkins.io/independent-scrolling-patch/node/">
Back to blog
</a>
</div>
<h1>
Docker Image: new Exit and Restart Behavior for Controllers
</h1>
<div class="post-attrs">
<a class="app-author-link" href="/blog/authors/dduportal/"><div class="app-avatar"><img alt="Damien DUPORTAL" class="app-avatar__image" src="/images/avatars/dduportal.jpg"></div> Damien DUPORTAL</a><a class="app-author-link" href="/blog/authors/basil/"><div class="app-avatar"></div> Basil Crow</a>
May 27, 2022
<a class="twitter-share-button" data-lang="en" href="https://twitter.com/intent/tweet?text=Docker+Image%3A+new+Exit+and+Restart+Behavior+for+Controllers&amp;url=https%3A%2F%2Fwww.jenkins.io%2Fjenkins.io%2Findependent-scrolling-patch%2Fblog%2F2022%2F05%2F27%2Fdocker-image-new-lifecycle%2F" rel="noreferrer nofollow" target="_blank">
Tweet
</a>
</div>
<div class="blog-content">
<div class="paragraph">
<p>The Jenkins project provides Docker images for controllers (and more).
Beginning with <a href="/changelog/#v2.344">Jenkins 2.344</a> released April 18, 2022 and <a href="/changelog-stable/#v2.332.3">Jenkins 2.332.3</a> released May 04, 2022, the behavior of the "Exit" and "Restart" lifecycle of the controller image <code>jenkins/jenkins</code> changed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>TL;DR; Ensure that you have a Container Restart Policy</p>
</div>
<div class="paragraph">
<p>For quick readers: check the <a href="#how-to-add-a-container-restart-policy">How to Add a Container Restart Policy</a> section for immediate actions to be taken.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="application-lifecycle-in-a-container-world"><a class="anchor" href="#application-lifecycle-in-a-container-world"></a>Application Lifecycle in a Container World</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jenkins previously restarted itself after upgrading plugins or via the <code>/restart</code> or <code>/safeRestart</code> endpoints by calling <code>exec(2)</code>.
This was fragile and exposed users to a variety of bugs.</p>
</div>
<div class="paragraph">
<p>The <code>ExitLifecycle</code> implementation allows the main process to exit normally before starting it again from scratch,
relying on the exit code to signal to the container orchestrator that the container ought to be restarted rather than to remain shut down.</p>
</div>
<div class="paragraph">
<p>Avoiding <code>exec(2)</code> from Java code, with all the associated complexity of closing file handles and making low-level system calls via JNA, eliminates exposure to a category of bugs.</p>
</div>
<div class="paragraph">
<p>You can read more about this on the following issues: <a href="https://github.com/jenkinsci/jenkins/pull/5899">jenkinsci/jenkins#5899</a> and <a href="https://github.com/jenkinsci/docker/pull/1268">jenkinsci/docker#1268</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="delegate-restarts-to-the-container-engine"><a class="anchor" href="#delegate-restarts-to-the-container-engine"></a>Delegate Restarts to the Container Engine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since the <a href="/changelog/#v2.344">Jenkins Weekly 2.344</a> and the <a href="/changelog-stable/#v2.332.3">Jenkins LTS 2.332.3</a>, the Docker image for Jenkins controller uses the new lifecycle <code>ExitLifecycle</code> by default.</p>
</div>
<div class="paragraph">
<p>It means that when the Jenkins controller triggers any "restart" or "exit" event, then its container exits.</p>
</div>
<div class="paragraph">
<p>If you are running Jenkins in a controller as a container, you should add a <a href="https://docs.docker.com/config/containers/start-containers-automatically/">"container restart policy"</a> different than <code>none</code> to ensure that the container is restarted automatically.</p>
</div>
<div class="paragraph">
<p>If you are running Jenkins in production in a container, chances are great that you already have a restart policy set and the change will be transparent.
But we updated the <a href="https://github.com/jenkinsci/docker">jenkinsci/docker documentation</a> to mention that the flag <code>--restart=on-failure</code> is set when starting a Jenkins controller container.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-to-add-a-container-restart-policy"><a class="anchor" href="#how-to-add-a-container-restart-policy"></a>How to Add a Container Restart Policy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you do not have a <a href="https://docs.docker.com/config/containers/start-containers-automatically/">container restart policy</a> defined, please find the different following methods depending on your container orchestrator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Docker Engine, Docker Swarm: add the <a href="https://docs.docker.com/engine/reference/run/#restart-policies---restart">flag <code>--restart=on-failure</code></a> to the <code>docker run &lt;&#8230;&#8203;&gt; jenkins/jenkins</code> command.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
No need to create a new container: you can use the command <code>docker update</code> to <a href="https://docs.docker.com/engine/reference/commandline/update/#update-a-containers-restart-policy">update the restart policy of an existing container</a>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Docker Compose: update your <code>docker-compose.yml</code> file to specify the <a href="https://docs.docker.com/compose/compose-file/#restart"><code>restart: on-failure</code> keyword</a> (or the <a href="https://docs.docker.com/compose/compose-file/deploy/#restart_policy"><code>deploy.restart_policy</code></a> if using <code>docker compose deploy</code> to a Docker Swarm cluster)</p>
</li>
<li>
<p>Kubernetes:</p>
<div class="ulist">
<ul>
<li>
<p>If you are using the official Jenkins helm-chart, make sure that you are using at least the version <a href="https://github.com/jenkinsci/helm-charts/releases/tag/jenkins-3.10.3"><code>3.10.3</code></a> of the Helm chart and you&#8217;re good to go, as per <a href="https://github.com/jenkinsci/helm-charts/issues/529">jenkinsci/helm-charts#529</a></p>
</li>
<li>
<p>Otherwise, ensure that you configure the Deployment for Jenkins to specify the <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy"><code>OnFailure</code> restart policy for the pods</a>. Please note that it&#8217;s the default policy if unspecified.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Hashicorp&#8217;s Nomad: Ensure that you specify a non-empty <a href="https://www.nomadproject.io/docs/job-specification/restart"><code>restart</code> stanza</a>. Please note that the <a href="https://www.nomadproject.io/docs/job-specification/restart#restart-parameter-defaults">default stanza behavior</a> behaves as expected: Jenkins is restarted.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<ul class="app-tags">
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/platform/">
platform
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/docker/">
docker
</a>
</li>
</ul>
<h2>
About the authors
</h2>
<!-- starting partial author.html.haml -->
<div class="app-author" id="about-the-author">
<!-- starting partial avatar.html.haml -->
<div class="app-avatar" style="min-width: 64px; width: 25vw; max-width: 128px">
<img alt="Damien DUPORTAL" class="app-avatar__image" src="/jenkins.io/independent-scrolling-patch/images/avatars/dduportal.jpg">
</div>

<!-- ending partial avatar.html.haml -->
<div class="app-author__content">
<p class="app-author__name">
<a href="/blog/authors/dduportal/">
Damien DUPORTAL
</a>
</p>
<div class="paragraph">
<p>Damien is the <a href="/project/team-leads/#infrastructure">Jenkins Infrastructure officer</a>
and a software engineer at <a href="https://www.cloudbees.com">CloudBees</a> working as a Site Reliability Engineer for the <a href="/projects/infrastructure/">Jenkins Infrastructure project</a>.
Not only he is a decade-old Hudson/Jenkins user but also an open-source citizen who participates in <a href="https://www.updatecli.io/">Updatecli</a>,
<a href="https://asciidoctor.org/">Asciidoctor</a>,
<a href="https://traefik.io/">Traefik</a> and many others.</p>
</div>
<!-- starting partial social-media-buttons.html.haml -->
<ul class="app-social-media-buttons">
<li>
<a href="https://github.com/dduportal" rel="noreferrer noopener" target="_blank">
GitHub
</a>
</li>
<li>
<a href="https://twitter.com/DamienDuportal" rel="noreferrer noopener" target="_blank">
Twitter
</a>
</li>
</ul>

<!-- ending partial social-media-buttons.html.haml -->
</div>
</div>

<!-- ending partial author.html.haml -->
<!-- starting partial author.html.haml -->
<div class="app-author" id="about-the-author">
<!-- starting partial avatar.html.haml -->
<div class="app-avatar" style="min-width: 64px; width: 25vw; max-width: 128px"></div>

<!-- ending partial avatar.html.haml -->
<div class="app-author__content">
<p class="app-author__name">
<a href="/blog/authors/basil/">
Basil Crow
</a>
</p>
<div class="paragraph">
<p>Basil is a long-time Jenkins user and contributor, a Jenkins core maintainer, and the maintainer of the <a href="https://plugins.jenkins.io/email-ext">Email Extension</a>, <a href="https://plugins.jenkins.io/timestamper">Timestamper</a>, and <a href="https://plugins.jenkins.io/swarm">Swarm</a> plugins (among others).
Basil enjoys working on open source software in his free time.</p>
</div>
<!-- starting partial social-media-buttons.html.haml -->
<ul class="app-social-media-buttons">
<li>
<a href="https://github.com/basil" rel="noreferrer noopener" target="_blank">
GitHub
</a>
</li>
<li>
<a href="https://twitter.com/bcrow" rel="noreferrer noopener" target="_blank">
Twitter
</a>
</li>
<li>
<a href="https://www.linkedin.com/in/basilcrow" rel="noreferrer noopener" target="_blank">
LinkedIn
</a>
</li>
</ul>

<!-- ending partial social-media-buttons.html.haml -->
</div>
</div>

<!-- ending partial author.html.haml -->
<!-- starting partial discuss.html.haml -->

<!-- ending partial discuss.html.haml -->
</article>


<script src="/jenkins.io/independent-scrolling-patch/assets/bower/anchor-js/anchor.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/@popperjs/core/umd/popper.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lit@2.5.0/polyfill-support.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.6.0/webcomponents-loader.js"></script>
<script data="ionicons" defer="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.esm.js" type="module"></script>
<script data="ionicons" defer="" nomodule="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/+esm" type="module"></script>
<script defer="" nomodule="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/"></script>
<jio-footer githubBranch="master" githubRepo="jenkins-infra/jenkins.io" property="https://www.jenkins.io" sourcePath="content//blog/2022/05/2022-05-27-docker-image-new-lifecycle.adoc"></jio-footer>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-000000-0', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  $(function(){
    var $body = $(document.body);
    $body.on("keydown", function(){
      $body.removeClass("no-outline");
    })
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3" type="text/javascript"></script>
<script type="text/javascript">
docsearch({
  container: document.querySelector('input.searchbox').parentNode,
  indexName: 'jenkins',
  appId: "M6L7Q4Z8HS",
  apiKey: "52f8dfbff76ffd9106f1c68fee16154b",
  algoliaOptions: { 'facetFilters': ["tags:en"] },
  debug: false
});
</script>
</body>
</html>
