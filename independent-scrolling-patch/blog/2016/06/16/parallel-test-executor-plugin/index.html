<!DOCTYPE html>
<html lang="en">
<head>
<title>
Faster Pipelines with the Parallel Test Executor Plugin
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="description">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2016/06/16/parallel-test-executor-plugin/" rel="canonical">
<!-- Favicons -->
<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="/site.webmanifest" rel="manifest">
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon">
<meta content="#2b5797" name="msapplication-TileColor">
<meta content="#ffffff" name="theme-color">
<meta content="Faster Pipelines with the Parallel Test Executor Plugin" name="apple-mobile-web-app-title">
<!-- Twitter Card data -->
<meta content="summary_large_image" name="twitter:card">
<meta content="@JenkinsCI" name="twitter:site">
<meta content="Faster Pipelines with the Parallel Test Executor Plugin" name="twitter:title">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="twitter:description">
<meta content="@JenkinsCI" name="twitter:creator">
<!-- Twitter Summary card images must be at least 120x120px -->
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="twitter:image">
<!-- Open Graph data -->
<meta content="Faster Pipelines with the Parallel Test Executor Plugin" property="og:title">
<meta content="article" property="og:type">
<meta content="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2016/06/16/parallel-test-executor-plugin/" property="og:url">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="og:description">
<meta content="Faster Pipelines with the Parallel Test Executor Plugin" property="og:site_name">
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="og:image">
<link href="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/jenkins.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/stylesheets/styles.css" media="screen" rel="stylesheet">
<!-- Non-obtrusive CSS styles -->
<link href="/jenkins.io/independent-scrolling-patch/css/footer.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/font-awesome.min.css" media="screen" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" rel="stylesheet">
</head>
<body>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/jquery/jquery.min.js"></script>
<!-- starting partial toptoolbar.html.haml -->
<jio-navbar class="fixed-top" id="ji-toolbar" property="https://www.jenkins.io" showSearchBox=""></jio-navbar>
<!-- Spacing to make the fixed-top sticky navbar not occlude any content below it -->
<div class="pt-4">
&nbsp;
</div>

<!-- ending partial toptoolbar.html.haml -->
<!-- starting partial anchors.html.haml -->
<script>
  window.addEventListener('DOMContentLoaded', function () {
    for (var i = 1 ; i <= 6 ; i ++) {
      anchors.add('.app-post-page h' + i);
    }
  })
</script>

<!-- ending partial anchors.html.haml -->
<article class="container app-post-page">
<div class="app-!-display-flex">
<a class="app-back-link" href="/jenkins.io/independent-scrolling-patch/node/">
Back to blog
</a>
</div>
<h1>
Faster Pipelines with the Parallel Test Executor Plugin
</h1>
<div class="post-attrs">
<a class="app-author-link" href="/blog/authors/lnewman/"><div class="app-avatar"><img alt="Liam Newman" class="app-avatar__image" src="/images/avatars/lnewman.jpeg"></div> Liam Newman</a>
June 16, 2016
<a class="twitter-share-button" data-lang="en" href="https://twitter.com/intent/tweet?text=Faster+Pipelines+with+the+Parallel+Test+Executor+Plugin&amp;url=https%3A%2F%2Fwww.jenkins.io%2Fjenkins.io%2Findependent-scrolling-patch%2Fblog%2F2016%2F06%2F16%2Fparallel-test-executor-plugin%2F" rel="noreferrer nofollow" target="_blank">
Tweet
</a>
</div>
<div class="blog-content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a guest post by <a href="https://github.com/bitwiseman">Liam Newman</a>,
Technical Evangelist at <a href="https://cloudbees.com">CloudBees</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this blog post, I’ll show you how to speed up your pipeline by using the
<a href="https://wiki.jenkins.io/display/JENKINS/Parallel+Test+Executor+Plugin">Parallel Test Executor Plugin</a>.</p>
</div>
<div class="sect2">
<h3 id="so-much-to-do-so-little-time"><a class="anchor" href="#so-much-to-do-so-little-time"></a>So much to do, so little time&#8230;&#8203;</h3>
<div class="paragraph">
<p>In my career, I&#8217;ve helped many teams move to continuous integration and delivery. One problem
we always encounter is how to run all the tests needed to ensure high-quality
changes while still keeping pipeline times reasonable and changes flowing
smoothly. More tests mean greater confidence, but also longer wait times.
Build systems may or may not support running tests in parallel, but they still only use one
machine even while other lab machines sit idle. In these cases, parallelizing
test execution across multiple machines is a great way to speed up pipelines.
The Parallel Test Executor plugin lets us leverage Jenkins do just that with no
disruption to the rest of the build system.</p>
</div>
</div>
<div class="sect2">
<h3 id="serial-test-execution"><a class="anchor" href="#serial-test-execution"></a>Serial Test Execution</h3>
<div class="paragraph">
<p>For this post, I’ll be running a pipeline based on the
<a href="https://github.com/jenkinsci/git-plugin">Jenkins Git Plugin</a>. I&#8217;ve modified
the Jenkinsfile from that project to allow us to compare execution times to our
later changes, and I&#8217;ve truncated the "mvn" utility method since it remains
unchanged.  You can find the original file
<a href="https://github.com/jenkinsci/git-plugin/blob/7a31858e61d2ca2e752b0e4f1285bddcb7a75c4d/Jenkinsfile">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span> <span class="o">{</span>
  <span class="n">stage</span> <span class="s1">'Checkout'</span>
  <span class="n">checkout</span> <span class="n">scm</span>

  <span class="n">stage</span> <span class="s1">'Build'</span>

  <span class="cm">/* Call the Maven build without tests. */</span>
  <span class="n">mvn</span> <span class="s2">"clean install -DskipTests"</span>

  <span class="n">stage</span> <span class="s1">'Test'</span>
  <span class="n">runTests</span><span class="o">()</span>

  <span class="cm">/* Save Results. */</span>
  <span class="n">stage</span> <span class="s1">'Results'</span>

  <span class="cm">/* Archive the build artifacts */</span>
  <span class="n">archive</span> <span class="nl">includes:</span> <span class="s1">'target/*.hpi,target/*.jpi'</span>
<span class="o">}</span>

<span class="kt">void</span> <span class="nf">runTests</span><span class="o">(</span><span class="kt">def</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="cm">/* Call the Maven build with tests. */</span>
  <span class="n">mvn</span> <span class="s2">"install -Dmaven.test.failure.ignore=true"</span>

  <span class="cm">/* Archive the test results */</span>
  <span class="n">junit</span> <span class="s1">'**/target/surefire-reports/TEST-*.xml'</span>
<span class="o">}</span>

<span class="cm">/* Run Maven */</span>
<span class="kt">void</span> <span class="nf">mvn</span><span class="o">(</span><span class="kt">def</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This pipeline expects to be run from a <code>Jenkinsfile</code> in SCM.
To copy and paste it directly into a Jenkins Pipeline job, replace the <code>checkout scm</code> step with
<code>git 'https://github.com/jenkinsci/git-plugin.git'</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is a Maven project, so the Jenkinsfile is pretty simple.
I’ve split the Maven build into separate “Build” and “Test”
stages. Maven doesn’t support this split very well, it wants to run all
the steps of the lifecycle in order every time. So, I have to call Maven twice:
first using the “skipTests” property to do only build steps in the first call,
and then a second time with out that property to run tests.</p>
</div>
<div class="paragraph">
<p>On my quad-core machine, executing this pipeline takes about 13 minutes and 30
seconds.  Of that time, it takes 13 minutes to run about 2.7 thousand tests in
serial.</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2016-06-16/serial.png" alt="Serial Test Pipeline">
</div>
</div>
</div>
<div class="sect2">
<h3 id="parallel-test-execution"><a class="anchor" href="#parallel-test-execution"></a>Parallel Test Execution</h3>
<div class="paragraph">
<p>This looks like an ideal project for parallel test execution: a short build
followed by a large number of serially executed tests that consume the most of
the pipeline time. There are a number of things I could try to speed this up.
For example, I could modify test harness to look for ways to parallelize
the test execution on this single machine. Or I could try speed up the tests
themselves. Both of those can be time-consuming and both risk destabilizing the
tests. I&#8217;d need to know more about the project to do it well.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll avoid that risk by using Jenkins and the
<a href="https://wiki.jenkins.io/display/JENKINS/Parallel+Test+Executor+Plugin">Parallel Test Executor Plugin</a> to
parallelize the tests across multiple nodes instead. This will isolate the tests
from each other, while still giving us speed gains from parallel execution.</p>
</div>
<div class="paragraph">
<p>The plugin reads the list of tests from the results archived in the previous execution of this
job and splits that list into a specified number of sublists. I can then use
those sublists to execute the tests in parallel, passing a different sublist to
each node.</p>
</div>
<div class="paragraph">
<p>Let’s look at how this changes the pipeline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span> <span class="o">{</span> <span class="cm">/* ...unchanged... */</span> <span class="o">}</span>

<span class="kt">void</span> <span class="nf">runTests</span><span class="o">(</span><span class="kt">def</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="cm">/* Request the test groupings.  Based on previous test results. */</span>
  <span class="cm">/* see https://wiki.jenkins.io/display/JENKINS/Parallel+Test+Executor+Plugin and demo on github
  /* Using arbitrary parallelism of 4 and "generateInclusions" feature added in v1.8. */</span>
  <span class="kt">def</span> <span class="n">splits</span> <span class="o">=</span> <span class="n">splitTests</span> <span class="nl">parallelism:</span> <span class="o">[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">'CountDrivenParallelism'</span><span class="o">,</span> <span class="nl">size:</span> <span class="mi">4</span><span class="o">],</span> <span class="nl">generateInclusions:</span> <span class="kc">true</span>

  <span class="cm">/* Create dictionary to hold set of parallel test executions. */</span>
  <span class="kt">def</span> <span class="n">testGroups</span> <span class="o">=</span> <span class="o">[:]</span>

  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">splits</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">split</span> <span class="o">=</span> <span class="n">splits</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>

    <span class="cm">/* Loop over each record in splits to prepare the testGroups that we'll run in parallel. */</span>
    <span class="cm">/* Split records returned from splitTests contain { includes: boolean, list: List&lt;String&gt; }. */</span>
    <span class="cm">/*     includes = whether list specifies tests to include (true) or tests to exclude (false). */</span>
    <span class="cm">/*     list = list of tests for inclusion or exclusion. */</span>
    <span class="cm">/* The list of inclusions is constructed based on results gathered from */</span>
    <span class="cm">/* the previous successfully completed job. One additional record will exclude */</span>
    <span class="cm">/* all known tests to run any tests not seen during the previous run.  */</span>
    <span class="n">testGroups</span><span class="o">[</span><span class="s2">"split-${i}"</span><span class="o">]</span> <span class="o">=</span> <span class="o">{</span>  <span class="c1">// example, "split3"</span>
      <span class="n">node</span> <span class="o">{</span>
        <span class="n">checkout</span> <span class="n">scm</span>

        <span class="cm">/* Clean each test node to start. */</span>
        <span class="n">mvn</span> <span class="s1">'clean'</span>

        <span class="kt">def</span> <span class="n">mavenInstall</span> <span class="o">=</span> <span class="s1">'install -DMaven.test.failure.ignore=true'</span>

        <span class="cm">/* Write includesFile or excludesFile for tests.  Split record provided by splitTests. */</span>
        <span class="cm">/* Tell Maven to read the appropriate file. */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">split</span><span class="o">.</span><span class="na">includes</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">writeFile</span> <span class="nl">file:</span> <span class="s2">"target/parallel-test-includes-${i}.txt"</span><span class="o">,</span> <span class="nl">text:</span> <span class="n">split</span><span class="o">.</span><span class="na">list</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s2">"\n"</span><span class="o">)</span>
          <span class="n">mavenInstall</span> <span class="o">+=</span> <span class="s2">" -Dsurefire.includesFile=target/parallel-test-includes-${i}.txt"</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">writeFile</span> <span class="nl">file:</span> <span class="s2">"target/parallel-test-excludes-${i}.txt"</span><span class="o">,</span> <span class="nl">text:</span> <span class="n">split</span><span class="o">.</span><span class="na">list</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s2">"\n"</span><span class="o">)</span>
          <span class="n">mavenInstall</span> <span class="o">+=</span> <span class="s2">" -Dsurefire.excludesFile=target/parallel-test-excludes-${i}.txt"</span>
        <span class="o">}</span>

        <span class="cm">/* Call the Maven build with tests. */</span>
        <span class="n">mvn</span> <span class="n">mavenInstall</span>

        <span class="cm">/* Archive the test results */</span>
        <span class="n">junit</span> <span class="s1">'**/target/surefire-reports/TEST-*.xml'</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">parallel</span> <span class="n">testGroups</span>
<span class="o">}</span>

<span class="cm">/* Run Maven */</span>
<span class="kt">void</span> <span class="nf">mvn</span><span class="o">(</span><span class="kt">def</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That’s it!  The change is significant but it is all encapsulated in this one
method in the <code>Jenkinsfile</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="great-ish-success"><a class="anchor" href="#great-ish-success"></a>Great (ish) Success!</h3>
<div class="paragraph">
<p>Here&#8217;s the results for the new pipeline with parallel test execution:</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2016-06-16/serial-vs-parallel.png" alt="Pipeline Duration Comparison">
</div>
</div>
<div class="paragraph">
<p>The tests ran almost twice as fast, without changes outside pipeline.  Great!</p>
</div>
<div class="paragraph">
<p>However, I used 4 test executors, so why am I not seeing a 4x? improvement.
A quick review of the logs shows the problem: A small number of tests are taking up
to 5 minutes each to complete! This is actually good news. It means that I
should be able to see further improvement in pipeline throughput just by refactoring
those few long running tests into smaller parts.</p>
</div>
</div>
<div class="sect2">
<h3 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h3>
<div class="paragraph">
<p>While I would like to have seen closer to a 4x improvement to match to number
of executors, 2x is still perfectly respectable. If I were working on a group of projects
with similar pipelines, I&#8217;d be completely comfortable reusing these same changes
on my other project and I&#8217;d expect to similar improvement without any disruption to
other tools or processes.</p>
</div>
</div>
<div class="sect2">
<h3 id="links"><a class="anchor" href="#links"></a>Links</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.jenkins.io/display/JENKINS/Parallel+Test+Executor+Plugin" class="bare">https://wiki.jenkins.io/display/JENKINS/Parallel+Test+Executor+Plugin</a></p>
</li>
</ul>
</div>
</div>
</div>
<ul class="app-tags">
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/tutorial/">
tutorial
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/pipeline/">
pipeline
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/plugins/">
plugins
</a>
</li>
</ul>
<h2>
About the author
</h2>
<!-- starting partial author.html.haml -->
<div class="app-author" id="about-the-author">
<!-- starting partial avatar.html.haml -->
<div class="app-avatar" style="min-width: 64px; width: 25vw; max-width: 128px">
<img alt="Liam Newman" class="app-avatar__image" src="/jenkins.io/independent-scrolling-patch/images/avatars/lnewman.jpeg">
</div>

<!-- ending partial avatar.html.haml -->
<div class="app-author__content">
<p class="app-author__name">
<a href="/blog/authors/lnewman/">
Liam Newman
</a>
</p>
<div class="paragraph">
<p>Liam started his software career as a tester, which might explain why he&#8217;s such a fan of CI/CD and Pipeline as Code.
He has spent the majority of his software engineering career implementing Continuous Integration systems at companies big and small.
He is a Jenkins project contributor and an expert in Jenkins Pipeline, both Scripted and Declarative.
Liam currently works as a Jenkins Evangelist at <a href="https://cloudbees.com">CloudBees</a>.
When not at work, he enjoys testing gravity by doing Aikido.</p>
</div>
<!-- starting partial social-media-buttons.html.haml -->
<ul class="app-social-media-buttons">
<li>
<a href="https://github.com/bitwiseman" rel="noreferrer noopener" target="_blank">
GitHub
</a>
</li>
<li>
<a href="https://twitter.com/bitwiseman" rel="noreferrer noopener" target="_blank">
Twitter
</a>
</li>
</ul>

<!-- ending partial social-media-buttons.html.haml -->
</div>
</div>

<!-- ending partial author.html.haml -->
<!-- starting partial discuss.html.haml -->

<!-- ending partial discuss.html.haml -->
</article>


<script src="/jenkins.io/independent-scrolling-patch/assets/bower/anchor-js/anchor.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/@popperjs/core/umd/popper.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lit@2.5.0/polyfill-support.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.6.0/webcomponents-loader.js"></script>
<script data="ionicons" defer="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.esm.js" type="module"></script>
<script data="ionicons" defer="" nomodule="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/+esm" type="module"></script>
<script defer="" nomodule="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/"></script>
<jio-footer githubBranch="master" githubRepo="jenkins-infra/jenkins.io" property="https://www.jenkins.io" sourcePath="content//blog/2016/2016-06-16-parallel-test-executor-plugin.adoc"></jio-footer>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-000000-0', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  $(function(){
    var $body = $(document.body);
    $body.on("keydown", function(){
      $body.removeClass("no-outline");
    })
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3" type="text/javascript"></script>
<script type="text/javascript">
docsearch({
  container: document.querySelector('input.searchbox').parentNode,
  indexName: 'jenkins',
  appId: "M6L7Q4Z8HS",
  apiKey: "52f8dfbff76ffd9106f1c68fee16154b",
  algoliaOptions: { 'facetFilters': ["tags:en"] },
  debug: false
});
</script>
</body>
</html>
