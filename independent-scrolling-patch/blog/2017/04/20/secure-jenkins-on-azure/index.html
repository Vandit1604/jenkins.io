<!DOCTYPE html>
<html lang="en">
<head>
<title>
Securing a Jenkins instance on Azure
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="description">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2017/04/20/secure-jenkins-on-azure/" rel="canonical">
<!-- Favicons -->
<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="/site.webmanifest" rel="manifest">
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon">
<meta content="#2b5797" name="msapplication-TileColor">
<meta content="#ffffff" name="theme-color">
<meta content="Securing a Jenkins instance on Azure" name="apple-mobile-web-app-title">
<!-- Twitter Card data -->
<meta content="summary_large_image" name="twitter:card">
<meta content="@JenkinsCI" name="twitter:site">
<meta content="Securing a Jenkins instance on Azure" name="twitter:title">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="twitter:description">
<meta content="@JenkinsCI" name="twitter:creator">
<!-- Twitter Summary card images must be at least 120x120px -->
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="twitter:image">
<!-- Open Graph data -->
<meta content="Securing a Jenkins instance on Azure" property="og:title">
<meta content="article" property="og:type">
<meta content="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2017/04/20/secure-jenkins-on-azure/" property="og:url">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="og:description">
<meta content="Securing a Jenkins instance on Azure" property="og:site_name">
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="og:image">
<link href="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/jenkins.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/stylesheets/styles.css" media="screen" rel="stylesheet">
<!-- Non-obtrusive CSS styles -->
<link href="/jenkins.io/independent-scrolling-patch/css/footer.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/font-awesome.min.css" media="screen" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" rel="stylesheet">
</head>
<body>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/jquery/jquery.min.js"></script>
<!-- starting partial toptoolbar.html.haml -->
<jio-navbar class="fixed-top" id="ji-toolbar" property="https://www.jenkins.io" showSearchBox=""></jio-navbar>
<!-- Spacing to make the fixed-top sticky navbar not occlude any content below it -->
<div class="pt-4">
&nbsp;
</div>

<!-- ending partial toptoolbar.html.haml -->
<!-- starting partial anchors.html.haml -->
<script>
  window.addEventListener('DOMContentLoaded', function () {
    for (var i = 1 ; i <= 6 ; i ++) {
      anchors.add('.app-post-page h' + i);
    }
  })
</script>

<!-- ending partial anchors.html.haml -->
<article class="container app-post-page">
<div class="app-!-display-flex">
<a class="app-back-link" href="/jenkins.io/independent-scrolling-patch/node/">
Back to blog
</a>
</div>
<h1>
Securing a Jenkins instance on Azure
</h1>
<div class="post-attrs">
<a class="app-author-link" href="/blog/authors/clguiman/"><div class="app-avatar"></div> Claudiu Guiman</a>
April 20, 2017
<a class="twitter-share-button" data-lang="en" href="https://twitter.com/intent/tweet?text=Securing+a+Jenkins+instance+on+Azure&amp;url=https%3A%2F%2Fwww.jenkins.io%2Fjenkins.io%2Findependent-scrolling-patch%2Fblog%2F2017%2F04%2F20%2Fsecure-jenkins-on-azure%2F" rel="noreferrer nofollow" target="_blank">
Tweet
</a>
</div>
<div class="blog-content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a guest post by <a href="https://github.com/clguimanMSFT">Claudiu Guiman</a> and <a href="https://github.com/EricJizbaMSFT">Eric Jizba</a>,
Software Engineers in the <a href="https://azure.microsoft.com/en-us/try/devops">Azure DevOps</a> team at <a href="https://www.microsoft.com">Microsoft</a>. If you have any questions, please email us at <a href="mailto:azdevopspub@microsoft.com">azdevopspub@microsoft.com</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One of the most frequently asked questions for managing a Jenkins instance is
"How do I make it secure?" Like any other web application, these issues must be
solved:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How do I securely pass secrets between the browser and the server?</p>
</li>
<li>
<p>How do I hide certain parts from unauthorized users and show other parts to anonymous users?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This blog post details how to securely connect to a Jenkins instance and how to
setup a read-only public dashboard.  We&#8217;ll cover topics like: setting up a
reverse proxy, blocking inbound requests to certain URLs and ports, enabling
project-based authorization, and making the Jenkins agents accessible through
the JNLP protocol.</p>
</div>
<div class="sect1">
<h2 id="deploy-jenkins"><a class="anchor" href="#deploy-jenkins"></a>Deploy Jenkins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simplest way to deploy a secure Jenkins instance is by using the <a href="https://aka.ms/jenkins-on-azure">Azure Marketplace offer</a>. If you have an existing Jenkins instance or want to setup your instance manually, follow the steps below.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="securely-log-in-to-jenkins"><a class="anchor" href="#securely-log-in-to-jenkins"></a>Securely log in to Jenkins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After you&#8217;ve deployed your new virtual machine with a hosted Jenkins instance, you will notice that by default the instance listens on port 8080 using 'HTTP'. If you want to set up 'HTTPS' communication, you will need to provide an SSL certificate. Unfortunately, most certificate authorities are not cheap and other free services like <a href="https://letsencrypt.org/">Let&#8217;s Encrypt</a> have a very small quota (about 20 certificates per week for the entire 'azure.com' subdomain). The only other option is to use a self-signed certificate, but then users must explicitly verify and mark your certificate as trusted, which is not recommended.</p>
</div>
<div class="paragraph">
<p>If you do not setup 'HTTPS' communication, the best way to make sure the sign-in credentials are not leaked due to a <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">Man-in-the-middle</a> attack is to only log in using SSH tunneling.
An SSH tunnel is an encrypted tunnel created through an SSH protocol connection, which can be used to transfer unencrypted traffic over an unsecured network. Simply run this command:</p>
</div>
<div class="listingblock">
<div class="title">Linux or Mac</div>
<div class="content">
<pre class="nowrap">    ssh -L 8080:localhost:8080 &lt;username&gt;@&lt;domain name&gt;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows ( <a href="https://www.putty.org/">using PuTTY</a>)</div>
<div class="content">
<pre class="nowrap">    putty.exe -ssh -L 8080:localhost:8080 &lt;username&gt;@&lt;domain name&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>This command will open an SSH connection to your remote host and bind remote port 8080 to listen to requests coming from your local machine. Navigate to <a href="http://localhost:8080" class="bare">http://localhost:8080</a> on your local machine to view your Jenkins dashboard and you&#8217;ll be able to log in securely.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setup-a-reverse-proxy"><a class="anchor" href="#setup-a-reverse-proxy"></a>Setup a reverse proxy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you can securely log in to your Jenkins instance, you should prevent people from accidentally authenticating through the public (unsecured) interface. To achieve this, you can setup a reverse proxy on the Jenkins hosting machine that will listen on a different port (80 is the best candidate) and redirect only certain requests to port 8080.</p>
</div>
<div class="paragraph">
<p>Specifically, it is recommended to block the login and the CLI requests. Some CLI versions fall back to unsecure HTTP connections if they have problems establishing the secured connection. In most cases, users don&#8217;t need the CLI and it should be enabled on an as-needed basis.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install Nginx:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt-get update
sudo apt-get install nginx</pre>
</div>
</div>
</li>
<li>
<p>Open the Nginx config file:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo nano /etc/nginx/sites-enabled/default</pre>
</div>
</div>
</li>
<li>
<p>Modify the file to configure Nginx to work as a reverse proxy (you&#8217;ll need to update &lt;your domain name&gt;):</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">server {
    listen 80;
    server_name &lt;your domain name&gt;;
    # Uncomment the line bellow to change the default 403 error page
    # error_page 403 /secure-jenkins;
    location / {
        proxy_set_header        Host \$host:\$server_port;
        proxy_set_header        X-Real-IP \$remote_addr;
        proxy_set_header        X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto \$scheme;
        proxy_pass              http://localhost:8080;
        proxy_redirect          http://localhost:8080 http://&lt;your domain name&gt;;
        proxy_read_timeout      90;
    }
    #block requests to /cli
    location /cli {
        deny all;
    }
    #block requests to /login
    location ~ /login* {
        deny all;
    }
    # Uncomment the lines bellow to redirect /secure-jenkins
    #location /secure-jenkins {
    #  alias /usr/share/nginx/secure-jenkins;
    #}
}</pre>
</div>
</div>
<div class="paragraph">
<p>The first section tells the Nginx server to listen to any requests that come from port 80. It also contains a commented redirect of the 403 error to a custom location (we&#8217;ll get back to this later).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">    listen 80;
    server_name &lt;your domain name&gt;;
    # error_page 403 /secure-jenkins;</pre>
</div>
</div>
<div class="paragraph">
<p>The next section describes the reverse proxy configuration. This tells the Nginx server to take all incoming requests and proxy them to the Jenkins instance that is listening to port 8080 on the local network interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">    location / {
        proxy_set_header        Host \$host:\$server_port;
        proxy_set_header        X-Real-IP \$remote_addr;
        proxy_set_header        X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto \$scheme;
        proxy_pass              http://localhost:8080;
        proxy_redirect          http://localhost:8080 http://&lt;your domain name&gt;;
        proxy_read_timeout      90;
    }</pre>
</div>
</div>
<div class="paragraph">
<p>The last section filters out specific URLs (login, cli) and denies access to them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">    location /cli {
        deny all;
    }
    location ~ /login* {
        deny all;
    }</pre>
</div>
</div>
</li>
<li>
<p>Restart Nginx:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo service nginx restart</pre>
</div>
</div>
</li>
<li>
<p>Go to <code>http://&lt;your domain name&gt;</code> and verify you can access your Jenkins instance.</p>
</li>
<li>
<p>Verify clicking 'login' returns a '403 Forbidden' page. If you want to customize that page, update the Nginx configuration and remove the comments around /secure-jenkins. This will redirect all 403 errors to the file <code>/usr/share/nginx/secure-jenkins</code>. You can add any content to that file, for example:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /usr/share/nginx/secure-jenkins
echo "Access denied! Use SSH tunneling to log in to your Jenkins instance!" | sudo tee /usr/share/nginx/secure-jenkins/index.html</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If restart fails or you cannot access your instance, check the error log: <code>cat /var/log/nginx/error.log</code>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="secure-your-jenkins-dashboard"><a class="anchor" href="#secure-your-jenkins-dashboard"></a>Secure your Jenkins dashboard</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you go to <code>http://&lt;your domain name&gt;:8080</code> you&#8217;ll notice you can still
bypass the reverse proxy and access the Jenkins instance directly through an
unsecure channel. You can easily block all inbound requests on port 8080 on
Azure with a
<a href="https://docs.microsoft.com/azure/virtual-network/virtual-networks-nsg">Network
Security Group</a> (NSG).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the NSG and add it to your existing network interface or to the subnet your Azure Virtual Machine is bound to.</p>
</li>
<li>
<p>Add 2 inbound security rules:</p>
<div class="ulist">
<ul>
<li>
<p>Allow requests to port 22 so you can SSH into the machine.</p>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2017-04-20/nsg-ssh.png" alt="nsg ssh">
</div>
</div>
</li>
<li>
<p>Allow requests to port 80 so the reverse proxy can be reached</p>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2017-04-20/nsg-http.png" alt="nsg http">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, all other external traffic will be blocked
</td>
</tr>
</table>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2017-04-20/nsg-inbound.png" alt="nsg inbound">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Navigate to <code>http://&lt;your domain name&gt;:8080</code> and verify you cannot connect.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t want to deploy an Azure Network Security Group, you can block port 8080 using the <a href="https://help.ubuntu.com/stable/ubuntu-help/net-firewall-on-off.html">Uncomplicated Firewall (ufw)</a>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-read-only-access-to-your-dashboard"><a class="anchor" href="#configure-read-only-access-to-your-dashboard"></a>Configure read-only access to your dashboard</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After installing Jenkins, the default security strategy is 'Logged-in users can do anything'. If you want to allow read-only access to anonymous users, you need to set up Matrix-based security. In this example, we&#8217;ll set up a project-based authorization matrix, so that you can make certain projects private and others public.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install the <a href="https://plugins.jenkins.io/matrix-auth">Matrix Authorization Strategy Plugin</a> and restart Jenkins.</p>
</li>
<li>
<p>Go to <a href="http://localhost:8080/configureSecurity/" class="bare">http://localhost:8080/configureSecurity/</a> ('Configure Global Security' page under 'Manage Jenkins') and select 'Project-base Matrix Authorization Strategy' from the 'Authorization' options.</p>
</li>
<li>
<p>As an example, you can grant read-only access to anonymous users (Overall/Read, Job/Discover and Job/Read should be enough) and grant all logged in users full access in a  group called 'authenticated':</p>
</li>
</ol>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2017-04-20/auth-matrix.png" alt="auth matrix" width="1000">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connect-jnlp-based-agents"><a class="anchor" href="#connect-jnlp-based-agents"></a>Connect JNLP-based agents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since your Jenkins instance is only accessible through the reverse proxy on port 80, any Jenkins agents that use the JNLP protocol will not be able to register to the controller anymore. To overcome this problem, all agents must be in the same virtual network as the Jenkins controller and must connect using their private IP (by default, the NSG allows all internal traffic).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that the Jenkins virtual machine will always be assigned the same private IP by going to the <a href="https://portal.azure.com/">Azure Portal</a>, opening the Network Interface of your virtual machine, opening 'IP configuration', and clicking on the configuration.</p>
</li>
<li>
<p>Make sure the Private IP has a static assignment and restart the virtual machine if necessary.</p>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/2017-04-20/private-ip.png" alt="private ip">
</div>
</div>
</li>
<li>
<p>Copy the static IP Address and go to <a href="http://localhost:8080/configure" class="bare">http://localhost:8080/configure</a> ('Configure System' page under 'Manage Jenkins') and update the 'Jenkins URL' to point to that private IP (<code>https://10.0.0.5:8080/</code> in this example)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now agents can communicate through JNLP. If you want to streamline the process,
you can use the
<a href="https://plugins.jenkins.io/azure-vm-agents">Azure VM Agents</a> plugin,
which automatically deploys agents in the same virtual network
and connects them to the controller.</p>
</div>
</div>
</div>
</div>
<ul class="app-tags">
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/azure/">
azure
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/cloud/">
cloud
</a>
</li>
</ul>
<h2>
About the author
</h2>
<!-- starting partial author.html.haml -->
<div class="app-author" id="about-the-author">
<!-- starting partial avatar.html.haml -->
<div class="app-avatar" style="min-width: 64px; width: 25vw; max-width: 128px"></div>

<!-- ending partial avatar.html.haml -->
<div class="app-author__content">
<p class="app-author__name">
<a href="/blog/authors/clguiman/">
Claudiu Guiman
</a>
</p>
This author has no biography defined.
See social media links referenced below.
<!-- starting partial social-media-buttons.html.haml -->
<ul class="app-social-media-buttons">
<li>
<a href="https://github.com/clguimanMSFT" rel="noreferrer noopener" target="_blank">
GitHub
</a>
</li>
</ul>

<!-- ending partial social-media-buttons.html.haml -->
</div>
</div>

<!-- ending partial author.html.haml -->
<!-- starting partial discuss.html.haml -->

<!-- ending partial discuss.html.haml -->
</article>


<script src="/jenkins.io/independent-scrolling-patch/assets/bower/anchor-js/anchor.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/@popperjs/core/umd/popper.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lit@2.5.0/polyfill-support.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.6.0/webcomponents-loader.js"></script>
<script data="ionicons" defer="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.esm.js" type="module"></script>
<script data="ionicons" defer="" nomodule="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/+esm" type="module"></script>
<script defer="" nomodule="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/"></script>
<jio-footer githubBranch="master" githubRepo="jenkins-infra/jenkins.io" property="https://www.jenkins.io" sourcePath="content//blog/2017/04/2017-04-20-secure-jenkins-on-azure.adoc"></jio-footer>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-000000-0', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  $(function(){
    var $body = $(document.body);
    $body.on("keydown", function(){
      $body.removeClass("no-outline");
    })
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3" type="text/javascript"></script>
<script type="text/javascript">
docsearch({
  container: document.querySelector('input.searchbox').parentNode,
  indexName: 'jenkins',
  appId: "M6L7Q4Z8HS",
  apiKey: "52f8dfbff76ffd9106f1c68fee16154b",
  algoliaOptions: { 'facetFilters': ["tags:en"] },
  debug: false
});
</script>
</body>
</html>
