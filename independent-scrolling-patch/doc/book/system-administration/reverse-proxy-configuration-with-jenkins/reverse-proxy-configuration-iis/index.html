<!DOCTYPE html>
<html lang="en">
<head>
<title>
Reverse proxy - IIS
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="description">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/" rel="canonical">
<!-- Favicons -->
<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="/site.webmanifest" rel="manifest">
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon">
<meta content="#2b5797" name="msapplication-TileColor">
<meta content="#ffffff" name="theme-color">
<meta content="Reverse proxy - IIS" name="apple-mobile-web-app-title">
<!-- Twitter Card data -->
<meta content="summary_large_image" name="twitter:card">
<meta content="@JenkinsCI" name="twitter:site">
<meta content="Reverse proxy - IIS" name="twitter:title">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="twitter:description">
<meta content="@JenkinsCI" name="twitter:creator">
<!-- Twitter Summary card images must be at least 120x120px -->
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="twitter:image">
<!-- Open Graph data -->
<meta content="Reverse proxy - IIS" property="og:title">
<meta content="article" property="og:type">
<meta content="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/" property="og:url">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="og:description">
<meta content="Reverse proxy - IIS" property="og:site_name">
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="og:image">
<link href="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/jenkins.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/stylesheets/styles.css" media="screen" rel="stylesheet">
<!-- Non-obtrusive CSS styles -->
<link href="/jenkins.io/independent-scrolling-patch/css/footer.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/font-awesome.min.css" media="screen" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" rel="stylesheet">
</head>
<body>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/jquery/jquery.min.js"></script>
<!-- starting partial toptoolbar.html.haml -->
<jio-navbar class="fixed-top" id="ji-toolbar" property="https://www.jenkins.io" showSearchBox=""></jio-navbar>
<!-- Spacing to make the fixed-top sticky navbar not occlude any content below it -->
<div class="pt-4">
&nbsp;
</div>

<!-- ending partial toptoolbar.html.haml -->
<!-- starting partial anchors.html.haml -->
<script>
  window.addEventListener('DOMContentLoaded', function () {
    for (var i = 1 ; i <= 6 ; i ++) {
      anchors.add('.container .row .col-lg-9 h' + i);
    }
  })
</script>

<!-- ending partial anchors.html.haml -->
<div class="container">
<div class="row body flex-lg-nowrap">
<div class="col-lg-3" id="sidebar-menu">
<div class="sidebar-nav tour" id="sidebar-content">
<p>
<a href="/jenkins.io/independent-scrolling-patch/doc/" class="">> User Documentation Home</a>
</p>
<h5>
User Handbook
</h5>
<ul>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/getting-started/" class="">User Handbook Overview</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/installing/" class="">Installing Jenkins</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/using/" class="">Using Jenkins</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/pipeline/" class="">Pipeline</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/blueocean/" class="">Blue Ocean</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/managing/" class="">Managing Jenkins</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/security/" class="">Securing Jenkins</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/" class="active">System Administration</a>
<small>
<ul style="padding-left: 1rem;">
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/backing-up/index.html" class="">Backing-up/Restoring Jenkins</a>
<ul style="padding-left: 1rem;">
</ul>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/monitoring/index.html" class="">Monitoring Jenkins</a>
<ul style="padding-left: 1rem;">
</ul>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/administering-jenkins-on-kubernetes/index.html" class="">Administering Jenkins on Kubernetes</a>
<ul style="padding-left: 1rem;">
</ul>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/with-chef/index.html" class="">Managing Jenkins with Chef</a>
<ul style="padding-left: 1rem;">
</ul>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/with-puppet/index.html" class="">Managing Jenkins with Puppet</a>
<ul style="padding-left: 1rem;">
</ul>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/viewing-logs/index.html" class="">Viewing logs</a>
<ul style="padding-left: 1rem;">
</ul>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/authenticating-scripted-clients/index.html" class="">Authenticating scripted clients</a>
<ul style="padding-left: 1rem;">
</ul>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/index.html" class="">Reverse proxy configuration</a>
<ul style="padding-left: 1rem;">
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-apache/" class="">Reverse proxy - Apache</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-nginx/" class="">Reverse proxy - Nginx</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-haproxy/" class="">Reverse proxy - HAProxy</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-squid/" class="">Reverse proxy - Squid</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis/" class="active">Reverse proxy - IIS</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iptables/" class="">Reverse proxy - iptables</a>
</li>
</ul>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/index.html" class="">Reverse proxy - Issues</a>
<ul style="padding-left: 1rem;">
</ul>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/system-administration/systemd-services/index.html" class="">Managing systemd services</a>
<ul style="padding-left: 1rem;">
</ul>
</li>
</ul>
</small>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/scaling/" class="">Scaling Jenkins</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/troubleshooting/" class="">Troubleshooting Jenkins</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/glossary/" class="">Glossary</a>
</li>
</ul>
<h5>
Tutorials
</h5>
<ul>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/pipeline/tour/getting-started/" class="">Guided Tour</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/tutorials#pipeline" class="">Jenkins Pipeline</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/tutorials#tools" class="">Using Build Tools</a>
</li>
</ul>
<h5>
Resources
</h5>
<ul>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/book/pipeline/syntax/" class="">Pipeline Syntax reference</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/pipeline/steps/" class="">Pipeline Steps reference</a>
</li>
<li>
<a href="/jenkins.io/independent-scrolling-patch/doc/upgrade-guide/" class="">LTS Upgrade guides</a>
</li>
</ul>
</div>
</div>
<div class="col-lg-9">
<style>
  .row.body {
    padding-top: 3rem;
  }
</style>
<div class="container">
<div class="row">
<div class="col-md-4">
<div class="row">
</div>
</div>
<div class="col-md-4">
</div>
<div class="col-md-4">
<div class="row">
</div>
</div>
</div>
<div class="row" style="padding-left: 5rem">
<a class="index" href="/jenkins.io/independent-scrolling-patch/doc/book/">
Index
</a>
</div>
</div>
<div class="container">
<div class="row body">
<div class="section">
<h1>
Reverse proxy - IIS
</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#requirements">Requirements</a></li>
<li><a href="#example-use-case">Example use case</a></li>
<li><a href="#configuration-time">Configuration Time</a>
<ul class="sectlevel2">
<li><a href="#enabling-reverse-proxy-functionality">Enabling Reverse Proxy functionality</a></li>
<li><a href="#configuring-tlsssl">Configuring TLS/SSL</a></li>
<li><a href="#configuring-rules-for-response-rewriting">Configuring rules for response rewriting</a></li>
<li><a href="#experiencing-the-dreaded-it-appears-that-your-reverse-proxy-set-up-is-broken-error-for-yourself">Experiencing the dreaded "It appears that your reverse proxy set up is broken." error for yourself</a></li>
<li><a href="#fixing-the-errors">Fixing the errors</a></li>
<li><a href="#continue-configuring-iis">Continue configuring IIS</a></li>
<li><a href="#a-working-web-config">A working web.config</a></li>
</ul>
</li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In situations where you have existing web sites on your server, you may
find it useful to run Jenkins (or the servlet container that Jenkins
runs in) behind IIS, so that you can bind Jenkins
to the part of a bigger website that you may have.
This section discusses some of the approaches for doing this.</p>
</div>
<div class="paragraph">
<p><strong>Make sure that you change the Jenkins httpListenAddress from its
default of 0.0.0.0 to 127.0.0.1 or configure the firewall to block
request on the port Jenkins is bound to, otherwise any IIS-level
restrictions can be easily bypassed by accessing the Jenkins port
directly.</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="requirements"><a class="anchor" href="#requirements"></a>Requirements</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>IIS 7.0 or greater.</p>
<div class="ulist">
<ul>
<li>
<p>IIS 8.5 or greater if you want
<a href="https://docs.microsoft.com/en-us/iis/get-started/whats-new-in-iis-85/certificate-rebind-in-iis85">Certificate
Rebind</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://www.iis.net/downloads/microsoft/url-rewrite">URL Rewrite 2.1</a>
or greater.</p>
<div class="ulist">
<ul>
<li>
<p>As the <a href="https://blogs.iis.net/iisteam/url-rewrite-v2-1">announcement</a>
explains, it introduces a feature flag to turn off the default
non-compliant-RFC3986 behavior. Which is what we want.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://www.iis.net/downloads/microsoft/application-request-routing">Application
Request Routing</a>  3.0 or greater.</p>
</li>
<li>
<p>Server access</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example-use-case"><a class="anchor" href="#example-use-case"></a>Example use case</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I have a dedicated Jenkins installation on a Windows Server 2012 R2
server with a Common Name of <strong>VRTJENKINS01</strong> in the Active Directory
domain <strong>acme.example</strong> and is reachable by the Fully Qualified Domain
Name <strong>vrtjenkins01.acme.example</strong>.
Additionally Jenkins runs on port <strong>8080</strong> and already listens to <strong>127.0.0.1</strong>
instead of 0.0.0.0 and the server has additional DNS names: <strong>jenkins</strong> and
<strong>jenkins.acme.example</strong>.</p>
</div>
<div class="paragraph">
<p>I want to have an IIS installation which acts as a TLS/SSL terminating
reverse proxy.
In combination with our in-house Active Directory Certificate Services
(ADCS, Microsoft&#8217;s Certificate Authority software) this should make
certificate management a lot easier since Windows can be configured to
automatically renew certificates, and the IIS 8.5+ Certificate Rebind
feature can listen to renewal events (which contain the fingerprints of
both the old and new certificate) and update the relevant bind(s) to use
the fresh certificate.
This would ensure that after the initial manual request it would only be
necessary to manually change TLS/SSL related settings when the set of
Alternate Subject Names on the certificate IIS presents should change.</p>
</div>
<div class="paragraph">
<p>IIS will only have to act as 1) a reverse proxy for Jenkins 2) redirect
non-canonical URLs to the canonical URL: <em>https://jenkins.acme.example/</em></p>
</div>
<div class="paragraph">
<p>I have installed the IIS (8.5) role using the <em>Add Roles and Features
Wizard</em> with the all the default and also the following non-default
features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HTTP Redirection (Under <em>Common HTTP Features</em>, to
redirect \http(s)://jenkins/, etc. to
<a href="https://jenkins.acme.example/" class="bare">https://jenkins.acme.example/</a>)</p>
</li>
<li>
<p>WebSocket Protocol (Under <em>Application Development</em>, because I felt
like it)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then I installed URL Rewrite and Application Request Routing.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-time"><a class="anchor" href="#configuration-time"></a>Configuration Time</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="enabling-reverse-proxy-functionality"><a class="anchor" href="#enabling-reverse-proxy-functionality"></a>Enabling Reverse Proxy functionality</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the <em>Internet Information Services (IIS) Manager</em> click on the
VRTJENKINS01 server.</p>
</li>
<li>
<p>Go to <em>Application Request Routing Cache</em>.</p>
</li>
<li>
<p>In the <em>Actions</em> panel click on <em>Server Proxy Settings&#8230;&#8203;</em></p>
</li>
<li>
<p>Enable the proxy</p>
</li>
<li>
<p>Disable the <em>Reverse rewrite host in response header</em></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Don&#8217;t worry, it will work, just follow the rest of the instructions</p>
</li>
</ol>
</div>
</li>
<li>
<p>Set the <em>Response buffer threshold (KB)</em> to 0.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>This helps to prevent HTTP 502 errors on Jenkin&#8217;s Replay pages.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Apply (the <em>Actions</em> panel again)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-tlsssl"><a class="anchor" href="#configuring-tlsssl"></a>Configuring TLS/SSL</h3>
<div class="paragraph">
<p>Out of scope, there are enough tutorials on the rest of the interwebs
for this part.
The rest of this tutorial will assume it has been configured with a
certificate trusted by your browser of choice.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-rules-for-response-rewriting"><a class="anchor" href="#configuring-rules-for-response-rewriting"></a>Configuring rules for response rewriting</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to the <em>Default Web Site</em></p>
</li>
<li>
<p>Go to <em>URL Rewrite</em></p>
</li>
<li>
<p>In the <em>Actions</em> panel click <em>View Server Variables&#8230;&#8203;</em></p>
</li>
<li>
<p>Add the following is not already define on the server level:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Name: <strong>HTTP_FORWARDED</strong></p>
</li>
</ol>
</div>
</li>
<li>
<p>Click on <em>Back to Rules</em></p>
</li>
<li>
<p><em>Click on Add Rule(s)&#8230;&#8203;</em></p>
</li>
<li>
<p>Select <em>Reverse Proxy</em> and click on OK</p>
</li>
<li>
<p>Enter <em>jenkins.acme.example</em> and click on OK</p>
</li>
<li>
<p>Open the rule you just created</p>
</li>
<li>
<p>Under <em>Conditions</em> add:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Condition input: <strong>{CACHE_URL}</strong></p>
</li>
<li>
<p>Pattern: <strong>^(http|ws)s://</strong></p>
</li>
</ol>
</div>
</li>
<li>
<p>Under <em>Server Variables</em> add:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Name: <strong>HTTP_FORWARDED</strong>, Value:
<strong>for={REMOTE_ADDR};by={LOCAL_ADDR};host="{HTTP_HOST}";proto="https"</strong>,
Replace: yes</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Jenkins runs under Jetty, Jetty supports
<a href="https://tools.ietf.org/html/rfc7239">RFC7239</a>, so all should be well.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Under Action change:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Rewrite URL to
<strong>\{C:1}\://jenkins.acme.example:8080{UNENCODED_URL}</strong></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Note that there is no slash between the port number and the opening
curly bracket</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Remove</strong> the check from the <strong>Append query string</strong> checkbox</p>
</li>
</ol>
</div>
</li>
<li>
<p>Apply the changes.</p>
</li>
<li>
<p>Edit <em>C:\Windows\System32\drivers\etc\hosts</em> so that
<strong>jenkins.acme.example</strong> points to 127.0.0.1</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>When resolving names Windows will check if the name is its own name
before consulting the hosts file. Meaning that adding <em>vrtjenkins01</em> or
<em>vrtjenkins01.acme.example</em> to the hosts file won&#8217;t have any effect.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>The hosts file will however be consulted before consulting the DNS
infrastructure</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="experiencing-the-dreaded-it-appears-that-your-reverse-proxy-set-up-is-broken-error-for-yourself"><a class="anchor" href="#experiencing-the-dreaded-it-appears-that-your-reverse-proxy-set-up-is-broken-error-for-yourself"></a>Experiencing the dreaded "It appears that your reverse proxy set up is broken." error for yourself</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>https://jenkins.acme.example/configure</p>
</li>
<li>
<p>Configure the <em>Jenkins URL</em> to
be <strong>https://jenkins.acme.example/</strong>
and save the change</p>
</li>
<li>
<p>Go to <em>Configure Global Security</em> and enable
<em>Enable proxy compatibility</em> if you have already enabled <em>Prevent Cross
Site Request Forgery exploits</em></p>
</li>
<li>
<p>Go to https://jenkins.acme.example/manage</p>
</li>
<li>
<p>You will still experience the "It appears that your reverse
proxy set up is broken." as expected</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you do not get that at this point, then that is very weird&#8230;&#8203;
Continue anyway.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Right click the <em>Configure System</em> link and choose to
inspect the element.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Make sure you are still on the Manage page as you will want
it as your referrer</p>
</li>
</ol>
</div>
</li>
<li>
<p>Change the value of the <em>href</em> attribute to be
<em>administrativeMonitor/hudson.diagnosis.ReverseProxySetupMonitor/test</em></p>
</li>
<li>
<p>Open the link you just changed in a new tab.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Keep this tab open</p>
</li>
</ol>
</div>
</li>
<li>
<p>Observe the "https://jenkins.acme.example/manage
vs http:" error and bask in its glory</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>a white page served with HTTP status code is 200 indicates
all is well</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>If you do get that at this point, then that is very
weird&#8230;&#8203; Continue anyway.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="fixing-the-errors"><a class="anchor" href="#fixing-the-errors"></a>Fixing the errors</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In IIS Manager got to <em>Application Pools</em> then edit
<em>DefaultAppPool</em> so that the <em>.NET CLR version</em> is <strong>No Managed Code</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>You might find that this is not necessary (at far as you
can tell) for your setup, since IIS will only act as a TLS/SSL
offloading reverse proxy, we don&#8217;t need it.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Then go to <em>Sites</em> → <em>Default Web Site</em> → <em>Request
Filtering</em> and in the <em>Actions</em> panel choose <em>Edit Feature Settings&#8230;&#8203;</em>
and turn on <strong>Allow double escaping</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>This is so IIS forwards URLs like
https://jenkins.acme.example/%2525 to Jenkins instead of
showing an IIS error page</p>
</li>
</ol>
</div>
</li>
<li>
<p>Last, but not least, go to <em>Sites</em> → <em>Default Web
Site</em> → <em>Configuration Editor</em> and change the <em>Section</em> to
<em>system.webServer/rewrite/rules</em></p>
</li>
<li>
<p>Now you should see the URL Rewrite 2.1 property
<em>useOriginalURLEncoding</em> listed, if not install URL Rewrite 2.1 using
the x86 or x64 installer, not the WebPI one and resume from here after a
reboot.</p>
</li>
<li>
<p>Change <em>useOriginalURLEncoding</em> to <strong>False</strong></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>As the URL Rewrite 2.1 announcement this will change the
value of {UNENCODED_URL} to make it <em>RFC3986</em> and usable for reverse
proxy forwarding purposes</p>
</li>
<li>
<p>original as in pre 2.1 behaviour.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Refresh that tab you were supposed to keep open, or recreate
it.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Again, take some time to bask in its glory</p>
</li>
</ol>
</div>
</li>
<li>
<p>It should now be white, also the Manage page should no
longer complain!</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="continue-configuring-iis"><a class="anchor" href="#continue-configuring-iis"></a>Continue configuring IIS</h3>
<div class="paragraph">
<p>Some of the things you might want but I won&#8217;t cover:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Hypertext Strict Transport Security</em> headers</p>
</li>
<li>
<p>Redirecting from non canonical URLs to the canonical URL
(ok, sort of covered this in the web.config example)</p>
</li>
<li>
<p>The X-UA-Compatibility header so that Internet Explorer 11
(or 9, or &#8230;&#8203;) won&#8217;t claim to be IE 7 for intranet sites</p>
</li>
<li>
<p>Use IIS Crypto to configure cipher suites</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="a-working-web-config"><a class="anchor" href="#a-working-web-config"></a>A working web.config</h3>
<div class="paragraph">
<p><strong>web.config</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;system.webServer&gt;</span>
    <span class="nt">&lt;rewrite&gt;</span>
      <span class="nt">&lt;rules</span> <span class="na">useOriginalURLEncoding=</span><span class="s">"false"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">"CanonicalHostNameRule2"</span> <span class="na">stopProcessing=</span><span class="s">"true"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;match</span> <span class="na">url=</span><span class="s">"(.*)"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;conditions</span> <span class="na">trackAllCaptures=</span><span class="s">"true"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;add</span> <span class="na">input=</span><span class="s">"{CACHE_URL}"</span> <span class="na">pattern=</span><span class="s">"^(http|ws)://"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;add</span> <span class="na">input=</span><span class="s">"{HTTP_HOST}"</span>
                 <span class="na">pattern=</span><span class="s">"^jenkins$|^jenkins\.acme\.example$|
                          ^vrtjenkins01$|^vrtjenkins01\.acme\.example$"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/conditions&gt;</span>
          <span class="nt">&lt;action</span> <span class="na">type=</span><span class="s">"Redirect"</span>
                  <span class="na">url=</span><span class="s">"{C:1}s://jenkins.acme.example{UNENCODED_URL}"</span>
                  <span class="na">appendQueryString=</span><span class="s">"false"</span>
                  <span class="na">redirectType=</span><span class="s">"Permanent"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/rule&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">"CanonicalHostNameRule1"</span> <span class="na">stopProcessing=</span><span class="s">"true"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;match</span> <span class="na">url=</span><span class="s">"(.*)"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;conditions</span> <span class="na">trackAllCaptures=</span><span class="s">"true"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;add</span> <span class="na">input=</span><span class="s">"{CACHE_URL}"</span> <span class="na">pattern=</span><span class="s">"^(https|wss)://"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;add</span> <span class="na">input=</span><span class="s">"{HTTP_HOST}"</span> <span class="na">pattern=</span><span class="s">"^jenkins$|^vrtjenkins01$|
                                              ^vrtjenkins01\.acme\.example$"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/conditions&gt;</span>
          <span class="nt">&lt;action</span> <span class="na">type=</span><span class="s">"Redirect"</span>
                  <span class="na">url=</span><span class="s">"{C:1}://jenkins.acme.example{UNENCODED_URL}"</span>
                  <span class="na">appendQueryString=</span><span class="s">"false"</span> <span class="na">redirectType=</span><span class="s">"Permanent"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/rule&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">"ReverseProxyInboundRule1"</span> <span class="na">stopProcessing=</span><span class="s">"true"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;match</span> <span class="na">url=</span><span class="s">"(.*)"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;action</span> <span class="na">type=</span><span class="s">"Rewrite"</span>
                  <span class="na">url=</span><span class="s">"{C:1}://jenkins.acme.example:8080{UNENCODED_URL}"</span>
                  <span class="na">appendQueryString=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;serverVariables&gt;</span>
            <span class="nt">&lt;set</span> <span class="na">name=</span><span class="s">"HTTP_FORWARDED"</span>
                 <span class="na">value=</span><span class="s">"for={REMOTE_ADDR};
                        by={LOCAL_ADDR};
                        host=&amp;quot;{HTTP_HOST}&amp;quot;;
                        proto=&amp;quot;https&amp;quot;"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/serverVariables&gt;</span>
          <span class="nt">&lt;conditions</span> <span class="na">trackAllCaptures=</span><span class="s">"true"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;add</span> <span class="na">input=</span><span class="s">"{CACHE_URL}"</span> <span class="na">pattern=</span><span class="s">"^(http|ws)s://"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;add</span> <span class="na">input=</span><span class="s">"{HTTP_HOST}"</span> <span class="na">pattern=</span><span class="s">"^jenkins\.acme\.example$"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/conditions&gt;</span>
        <span class="nt">&lt;/rule&gt;</span>
      <span class="nt">&lt;/rules&gt;</span>
    <span class="nt">&lt;/rewrite&gt;</span>
    <span class="nt">&lt;security&gt;</span>
      <span class="nt">&lt;requestFiltering</span> <span class="na">allowDoubleEscaping=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/security&gt;</span>
  <span class="nt">&lt;/system.webServer&gt;</span>
<span class="nt">&lt;/configuration&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<hr>
<div class="container">
<div class="row">
<div class="col-md-4">
<div class="row">
</div>
</div>
<div class="col-md-4">
</div>
<div class="col-md-4">
<div class="row">
</div>
</div>
</div>
<div class="row" style="padding-left: 5rem">
<a class="index" href="/jenkins.io/independent-scrolling-patch/doc/book/">
Index
</a>
</div>
</div>
<hr>
<div class="container"></div>
<!-- starting partial _feedback-footer.html -->
<!-- HTML inclusion for chapter and section layouts (i.e. as footers) as well as
     for use in AsciiDoc file inclusions. -->

<!--
This feedback form was prepared from a Google Form, based on the techniques in
the following documentation sources:
https://codepen.io/learningcode/post/customize-a-google-form-for-your-website,
https://mrhaki.blogspot.com.au/2014/06/awesome-asciidoc-include-raw-html.html,
https://www.freshtechtips.com/2013/05/custom-google-drive-contact-form.html,
https://stackoverflow.com/questions/24436165/set-value-of-hidden-input-inside-form
-->

<!-- Feedback form functionality in JavaScript - refer to comments in this file
     for details on the functionality. -->
<script>
var feedbackForm = {
    formKey : 'e/1FAIpQLSfCEexH09x_-ytEyE7wetizqOvE_-06WkK89dpBLEJcYnOp8w'
};
$(document).ready(function() {
    window.onload = feedbackForm.start(window.location.href);
});
</script>
<script src="/js/feedback-form-functionality.js"></script>

<p><a href="#feedback" data-bs-toggle="collapse">Was this page helpful?</a></p>

<div id="feedback" class="collapse">

<p>Please submit your feedback about this page through this
<a href="/doc/feedback-form/">quick form</a>.</p>

<p>Alternatively, if you don't wish to complete the quick form, you can simply
indicate if you found this page helpful?</p>

<!-- Redirects to custom "thank you" page once form is submitted. -->
<script type="text/javascript">
var submitted=false;
</script>
<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"
onload="if(submitted) {window.location='/doc/thank-you-for-your-feedback/';}">
</iframe>
<form action="https://docs.google.com/forms/d/e/1FAIpQLSfCEexH09x_-ytEyE7wetizqOvE_-06WkK89dpBLEJcYnOp8w/formResponse" method="POST" id="ss-form" target="hidden_iframe" onsubmit="submitted=true;">

<!-- Set the value of the current URL into the form. -->
<input type="hidden" name="entry.1246830226" id="current-url" value=""/>

<!-- The answer bit -->
<p><input type="radio" name="entry.790002525" id="h1" value="Yes" required/>
<label for="h1">Yes</label>&nbsp;&nbsp;&nbsp;&nbsp;
<input type="radio" name="entry.790002525" id="h2" value="No"/>
<label for="h2">No</label></p>

<!-- The CAPTCHA bit -->

<p><label id="ssTestLabel" for="ssTestValue"></label><br/>
<input type="text" name="ssTestValue" value="" id="ssTestValue"/></p>

<!-- Submit button -->

<p><input class="button" type="submit" value="Submit"/></p>

</form>

<p>See existing feedback <a href="https://docs.google.com/spreadsheets/d/1IIdpVs39JDYKg0sLQIv-MNO928qcGApAIfdW5ohfD78" target="_blank" rel="noreferrer noopener">here</a>.</p>

</div>

<!-- ending partial _feedback-footer.html -->

</div>
</div>
</div>


<script src="/jenkins.io/independent-scrolling-patch/assets/bower/anchor-js/anchor.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/@popperjs/core/umd/popper.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lit@2.5.0/polyfill-support.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.6.0/webcomponents-loader.js"></script>
<script data="ionicons" defer="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.esm.js" type="module"></script>
<script data="ionicons" defer="" nomodule="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/+esm" type="module"></script>
<script defer="" nomodule="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/"></script>
<jio-footer githubBranch="master" githubRepo="jenkins-infra/jenkins.io" property="https://www.jenkins.io" sourcePath="content//doc/book/system-administration/reverse-proxy-configuration-with-jenkins/reverse-proxy-configuration-iis.adoc"></jio-footer>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-000000-0', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  $(function(){
    var $body = $(document.body);
    $body.on("keydown", function(){
      $body.removeClass("no-outline");
    })
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3" type="text/javascript"></script>
<script type="text/javascript">
docsearch({
  container: document.querySelector('input.searchbox').parentNode,
  indexName: 'jenkins',
  appId: "M6L7Q4Z8HS",
  apiKey: "52f8dfbff76ffd9106f1c68fee16154b",
  algoliaOptions: { 'facetFilters': ["tags:en"] },
  debug: false
});
</script>
</body>
</html>
