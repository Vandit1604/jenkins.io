<!DOCTYPE html>
<html lang="en">
<head>
<title>
Migrating from chained Freestyle jobs to Pipelines
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="description">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2016/06/29/from-freestyle-to-pipeline/" rel="canonical">
<!-- Favicons -->
<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="/site.webmanifest" rel="manifest">
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon">
<meta content="#2b5797" name="msapplication-TileColor">
<meta content="#ffffff" name="theme-color">
<meta content="Migrating from chained Freestyle jobs to Pipelines" name="apple-mobile-web-app-title">
<!-- Twitter Card data -->
<meta content="summary_large_image" name="twitter:card">
<meta content="@JenkinsCI" name="twitter:site">
<meta content="Migrating from chained Freestyle jobs to Pipelines" name="twitter:title">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="twitter:description">
<meta content="@JenkinsCI" name="twitter:creator">
<!-- Twitter Summary card images must be at least 120x120px -->
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="twitter:image">
<!-- Open Graph data -->
<meta content="Migrating from chained Freestyle jobs to Pipelines" property="og:title">
<meta content="article" property="og:type">
<meta content="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2016/06/29/from-freestyle-to-pipeline/" property="og:url">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="og:description">
<meta content="Migrating from chained Freestyle jobs to Pipelines" property="og:site_name">
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="og:image">
<link href="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/jenkins.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/stylesheets/styles.css" media="screen" rel="stylesheet">
<!-- Non-obtrusive CSS styles -->
<link href="/jenkins.io/independent-scrolling-patch/css/footer.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/font-awesome.min.css" media="screen" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" rel="stylesheet">
</head>
<body>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/jquery/jquery.min.js"></script>
<!-- starting partial toptoolbar.html.haml -->
<jio-navbar class="fixed-top" id="ji-toolbar" property="https://www.jenkins.io" showSearchBox=""></jio-navbar>
<!-- Spacing to make the fixed-top sticky navbar not occlude any content below it -->
<div class="pt-4">
&nbsp;
</div>

<!-- ending partial toptoolbar.html.haml -->
<!-- starting partial anchors.html.haml -->
<script>
  window.addEventListener('DOMContentLoaded', function () {
    for (var i = 1 ; i <= 6 ; i ++) {
      anchors.add('.app-post-page h' + i);
    }
  })
</script>

<!-- ending partial anchors.html.haml -->
<article class="container app-post-page">
<div class="app-!-display-flex">
<a class="app-back-link" href="/jenkins.io/independent-scrolling-patch/node/">
Back to blog
</a>
</div>
<h1>
Migrating from chained Freestyle jobs to Pipelines
</h1>
<div class="post-attrs">
<a class="app-author-link" href="/blog/authors/rtyler/"><div class="app-avatar"><img alt="R. Tyler Croy" class="app-avatar__image" src="/images/avatars/rtyler.jpeg"></div> R. Tyler Croy</a>
June 29, 2016
<a class="twitter-share-button" data-lang="en" href="https://twitter.com/intent/tweet?text=Migrating+from+chained+Freestyle+jobs+to+Pipelines&amp;url=https%3A%2F%2Fwww.jenkins.io%2Fjenkins.io%2Findependent-scrolling-patch%2Fblog%2F2016%2F06%2F29%2Ffrom-freestyle-to-pipeline%2F" rel="noreferrer nofollow" target="_blank">
Tweet
</a>
</div>
<div class="blog-content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is a guest post by <a href="https://github.com/rtyler">R. Tyler Croy</a>, who is a
long-time contributor to Jenkins and the primary contact for Jenkins project
infrastructure. He is also a Jenkins Evangelist at
<a href="https://cloudbees.com">CloudBees, Inc.</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For ages I have used the "Build After" feature in Jenkins to cobble together
what one might refer to as a "pipeline" of sorts. The Jenkins project itself, a
major consumer of Jenkins, has used these daisy-chained Freestyle jobs to drive
a myriad of delivery pipelines in our infrastructure.</p>
</div>
<div class="paragraph">
<p>One such "pipeline" helped drive the complex process of generating the pretty
blue charts on
<a href="https://stats.jenkins.io/jenkins-stats/svg/svgs.html">stats.jenkins.io</a>.
This statistics generation process primarily performs two major tasks, on rather
large sets of data:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generate aggregate monthly "census data."</p>
</li>
<li>
<p>Process the census data and create trend charts</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The chained jobs allowed us to resume the independent stages of the pipeline,
and allowed us to run different stages on different hardware (different
capabilities) as needed. Below is a diagram of what this looked like:</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/freestyle-to-pipeline-2016/freestyle-pipeline.png" alt="freestyle pipeline">
</div>
</div>
<div class="paragraph">
<p>The <code>infra_generate_monthly_json</code> would run periodically creating the
aggregated census data, which would then be picked up by <code>infra_census_push</code>
whose sole responsibility was to take census data and publish it to the
necessary hosts inside the project&#8217;s infrastructure.</p>
</div>
<div class="paragraph">
<p>The second, semi-independent, "pipeline" would also run periodically. The
<code>infra_statistics</code> job&#8217;s responsibility was to use the census data, pushed
earlier by <code>infra_census_push</code>, to generate the myriad of pretty blue charts
before triggering the
<code>infra_checkout_stats</code> job which would make sure <code>stats.jenkins.io</code> was
properly updated.</p>
</div>
<div class="paragraph">
<p>Suffice it to say, this "pipeline" had grown organically over a period time when
<a href="/doc/pipeline">more advanced tools</a> weren&#8217;t quite available.</p>
</div>
<hr>
<div class="paragraph">
<p>When we migrated to newer infrastructure for
<a href="https://ci.jenkins.io">ci.jenkins.io</a> earlier this year I took the
opportunity to do some cleaning up. Instead of migrating jobs verbatim, I pruned
stale jobs and refactored a number of others into proper
<a href="/solutions/pipeline">Pipelines</a>, statistics generation being an obvious
target!</p>
</div>
<div class="paragraph">
<p>Our requirements for statistics generation, in their most basic form, are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable a sequence of dependent tasks to be executed as a logical group (a
pipeline)</p>
</li>
<li>
<p>Enable executing those dependent tasks on various pieces of infrastructure
which support different requirements</p>
</li>
<li>
<p>Actually generate those pretty blue charts</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you wish to skip ahead, you can jump straight to the
<a href="https://github.com/jenkins-infra/infra-statistics/blob/a6dcaa29fca9a4f61143954fb9e1300c2f995a89/Jenkinsfile">Jenkinsfile</a>
which implements our new Pipeline.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first iteration of the <code>Jenkinsfile</code> simply defined the conceptual stages we
would need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span> <span class="o">{</span>
    <span class="n">stage</span> <span class="s1">'Sync raw data and census files'</span>

    <span class="n">stage</span> <span class="s1">'Process raw logs'</span>

    <span class="n">stage</span> <span class="s1">'Generate census data'</span>

    <span class="n">stage</span> <span class="s1">'Generate stats'</span>

    <span class="n">stage</span> <span class="s1">'Publish census'</span>

    <span class="n">stage</span> <span class="s1">'Publish stats'</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>How exciting! Although not terrifically useful. When I began actually
implementing the first couple stages, I noticed that the Pipeline might sync
<em>dozens</em> of gigabytes of data every time it ran on a new agent in the cluster.
While this problem will soon be solved by the
<a href="https://github.com/jenkinsci/external-workspace-manager-plugin">External
Workspace Manager plugin</a>, which is currently being developed. Until it&#8217;s ready,
I chose to mitigate the issue by pinning the execution to a consistent agent.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="cm">/* `census` is a node label for a single machine, ideally, which will be
 * consistently used for processing usage statistics and generating census data
 */</span>
<span class="n">node</span><span class="o">(</span><span class="s1">'census &amp;&amp; docker'</span><span class="o">)</span> <span class="o">{</span>
    <span class="cm">/* .. */</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Restricting a workload which previously used multiple agents to a single one
introduced the next challenge. As an infrastructure administrator, technically
speaking, I <em>could</em> just install all the system dependencies that I want on this
one special Jenkins agent. But what kind of example would that be setting!</p>
</div>
<div class="paragraph">
<p>The statistics generation process requires:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK8</p>
</li>
<li>
<p><a href="http://www.groovy-lang.org">Groovy</a></p>
</li>
<li>
<p>A running <a href="https://www.mongodb.org/">MongoDB</a> instance</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Fortunately, with Pipeline we have a couple of useful features at our disposal:
tool auto-installers and the
<a href="https://go.cloudbees.com/docs/cloudbees-documentation/cje-user-guide/chapter-docker-workflow.html">CloudBees
Docker Pipeline plugin</a>.</p>
</div>
<div class="sect2">
<h3 id="tool-auto-installers"><a class="anchor" href="#tool-auto-installers"></a>Tool Auto-Installers</h3>
<div class="paragraph">
<p>Tool Auto-Installers are exposed in Pipeline through the <code>tool</code> step and on
<a href="https://ci.jenkins.io">ci.jenkins.io</a> we already had JDK8 and Groovy
available. This meant that the <code>Jenkinsfile</code> would invoke <code>tool</code> and Pipeline
would automatically install the desired tool on the agent executing the current
Pipeline steps.</p>
</div>
<div class="paragraph">
<p>The <code>tool</code> step does not modify the <code>PATH</code> environment variable, so it&#8217;s usually
used in conjunction with the <code>withEnv</code> step, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span><span class="o">(</span><span class="s1">'census &amp;&amp; docker'</span><span class="o">)</span> <span class="o">{</span>
    <span class="cm">/* .. */</span>

    <span class="kt">def</span> <span class="n">javaHome</span> <span class="o">=</span> <span class="n">tool</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">'jdk8'</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">groovyHome</span> <span class="o">=</span> <span class="n">tool</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">'groovy'</span><span class="o">)</span>

    <span class="cm">/* Set up environment variables for re-using our auto-installed tools */</span>
    <span class="kt">def</span> <span class="n">customEnv</span> <span class="o">=</span> <span class="o">[</span>
        <span class="s2">"PATH+JDK=${javaHome}/bin"</span><span class="o">,</span>
        <span class="s2">"PATH+GROOVY=${groovyHome}/bin"</span><span class="o">,</span>
        <span class="s2">"JAVA_HOME=${javaHome}"</span><span class="o">,</span>
    <span class="o">]</span>

    <span class="cm">/* use our auto-installed tools */</span>
    <span class="n">withEnv</span><span class="o">(</span><span class="n">customEnv</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s1">'java --version'</span>
    <span class="o">}</span>

    <span class="cm">/* .. */</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cloudbees-docker-pipeline-plugin"><a class="anchor" href="#cloudbees-docker-pipeline-plugin"></a>CloudBees Docker Pipeline plugin</h3>
<div class="paragraph">
<p>Satisfying the MongoDB dependency would still be tricky. If I caved in and installed
MongoDB on a single unicorn agent in the cluster, what could I say the next time
somebody asked for a special, one-off, piece of software installed on our
Jenkins build agents?</p>
</div>
<div class="paragraph">
<p>After doing my usual complaining and whining, I discovered that the CloudBees
Docker Pipeline plugin provides the ability to <strong>run containers</strong> inside of a
<code>Jenkinsfile</code>. To make things even better, there are
<a href="https://hub.docker.com/_/mongo/">official MongoDB docker images</a> readily
available on DockerHub!</p>
</div>
<div class="paragraph">
<p>This feature requires that the machine has a running Docker daemon which is
accessible to the user running the Jenkins agent. After that, running a
container in the background is easy, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span><span class="o">(</span><span class="s1">'census &amp;&amp; docker'</span><span class="o">)</span> <span class="o">{</span>
    <span class="cm">/* .. */</span>

    <span class="cm">/* Run MongoDB in the background, mapping its port 27017 to our host's port
     * 27017 so our script can talk to it, then execute our Groovy script with
     * tools from our `customEnv`
     */</span>
    <span class="n">docker</span><span class="o">.</span><span class="na">image</span><span class="o">(</span><span class="s1">'mongo:2'</span><span class="o">).</span><span class="na">withRun</span><span class="o">(</span><span class="s1">'-p 27017:27017'</span><span class="o">)</span> <span class="o">{</span> <span class="n">container</span> <span class="o">-&gt;</span>
        <span class="n">withEnv</span><span class="o">(</span><span class="n">customEnv</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sh</span> <span class="s2">"groovy parseUsage.groovy --logs ${usagestats_dir} --output ${census_dir} --incremental"</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* .. */</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The beauty, to me, of this example is that you can pass a
<a href="http://www.groovy-lang.org/Closures">closure</a> to <code>withRun</code> which will
execute <em>while</em> the container is running. When the closure is finished executing,
just the <code>sh</code> step in this case, the container is destroyed.</p>
</div>
<div class="paragraph">
<p>With that system requirement satisfied, the rest of the stages of the Pipeline
fell into place. We now have a single source of truth, the
<a href="https://github.com/jenkins-infra/infra-statistics/blob/master/Jenkinsfile">Jenkinsfile</a>,
for the sequence of dependent tasks which need to be executed, accounting for
variations in systems requirements, and it actually generates
<a href="https://stats.jenkins.io/jenkins-stats/svg/svgs.html">those pretty
blue charts</a>!</p>
</div>
<div class="paragraph">
<p>Of course, a nice added bonus is the beautiful visualization of our
<a href="https://ci.jenkins.io/job/Infra/job/infra-statistics/">new Pipeline</a>!</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/freestyle-to-pipeline-2016/stats-pipeline.png" alt="The New and Improved Statistics Pipeline">
</div>
</div>
</div>
<div class="sect2">
<h3 id="links"><a class="anchor" href="#links"></a>Links</h3>
<div class="ulist">
<ul>
<li>
<p><a href="/doc/pipeline">Pipeline documentation</a></p>
</li>
<li>
<p><a href="https://go.cloudbees.com/docs/cloudbees-documentation/cje-user-guide/chapter-docker-workflow.html">CloudBees Docker Pipeline plugin documentation</a></p>
</li>
<li>
<p>Live <a href="https://ci.jenkins.io/job/Infra/job/infra-statistics/">statistics Pipeline</a></p>
</li>
</ul>
</div>
</div>
</div>
<ul class="app-tags">
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/pipeline/">
pipeline
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/infra/">
infra
</a>
</li>
</ul>
<h2>
About the author
</h2>
<!-- starting partial author.html.haml -->
<div class="app-author" id="about-the-author">
<!-- starting partial avatar.html.haml -->
<div class="app-avatar" style="min-width: 64px; width: 25vw; max-width: 128px">
<img alt="R. Tyler Croy" class="app-avatar__image" src="/jenkins.io/independent-scrolling-patch/images/avatars/rtyler.jpeg">
</div>

<!-- ending partial avatar.html.haml -->
<div class="app-author__content">
<p class="app-author__name">
<a href="/blog/authors/rtyler/">
R. Tyler Croy
</a>
</p>
<div class="paragraph">
<p>R&#46; Tyler Croy has been part of the Jenkins project for the past seven years.
While avoiding contributing any Java code, Tyler is involved in many of the
other aspects of the project which keep it running, such as this website,
infrastructure, governance, etc.</p>
</div>
<!-- starting partial social-media-buttons.html.haml -->
<ul class="app-social-media-buttons">
<li>
<a href="https://github.com/rtyler" rel="noreferrer noopener" target="_blank">
GitHub
</a>
</li>
<li>
<a href="https://twitter.com/agentdero" rel="noreferrer noopener" target="_blank">
Twitter
</a>
</li>
<li>
<a href="http://unethicalblogger.com" rel="noreferrer noopener" target="_blank">
Blog
</a>
</li>
</ul>

<!-- ending partial social-media-buttons.html.haml -->
</div>
</div>

<!-- ending partial author.html.haml -->
<!-- starting partial discuss.html.haml -->

<!-- ending partial discuss.html.haml -->
</article>


<script src="/jenkins.io/independent-scrolling-patch/assets/bower/anchor-js/anchor.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/@popperjs/core/umd/popper.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lit@2.5.0/polyfill-support.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.6.0/webcomponents-loader.js"></script>
<script data="ionicons" defer="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.esm.js" type="module"></script>
<script data="ionicons" defer="" nomodule="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/+esm" type="module"></script>
<script defer="" nomodule="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/"></script>
<jio-footer githubBranch="master" githubRepo="jenkins-infra/jenkins.io" property="https://www.jenkins.io" sourcePath="content//blog/2016/2016-06-29-from-freestyle-to-pipeline.adoc"></jio-footer>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-000000-0', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  $(function(){
    var $body = $(document.body);
    $body.on("keydown", function(){
      $body.removeClass("no-outline");
    })
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3" type="text/javascript"></script>
<script type="text/javascript">
docsearch({
  container: document.querySelector('input.searchbox').parentNode,
  indexName: 'jenkins',
  appId: "M6L7Q4Z8HS",
  apiKey: "52f8dfbff76ffd9106f1c68fee16154b",
  algoliaOptions: { 'facetFilters': ["tags:en"] },
  debug: false
});
</script>
</body>
</html>
