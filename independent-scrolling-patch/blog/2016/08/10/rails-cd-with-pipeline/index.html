<!DOCTYPE html>
<html lang="en">
<head>
<title>
Continuous Security for Rails apps with Pipeline and Brakeman
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="description">
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="ie=edge" http-equiv="x-ua-compatible">
<link href="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2016/08/10/rails-cd-with-pipeline/" rel="canonical">
<!-- Favicons -->
<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="/site.webmanifest" rel="manifest">
<link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon">
<meta content="#2b5797" name="msapplication-TileColor">
<meta content="#ffffff" name="theme-color">
<meta content="Continuous Security for Rails apps with Pipeline and Brakeman" name="apple-mobile-web-app-title">
<!-- Twitter Card data -->
<meta content="summary_large_image" name="twitter:card">
<meta content="@JenkinsCI" name="twitter:site">
<meta content="Continuous Security for Rails apps with Pipeline and Brakeman" name="twitter:title">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="twitter:description">
<meta content="@JenkinsCI" name="twitter:creator">
<!-- Twitter Summary card images must be at least 120x120px -->
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="twitter:image">
<!-- Open Graph data -->
<meta content="Continuous Security for Rails apps with Pipeline and Brakeman" property="og:title">
<meta content="article" property="og:type">
<meta content="https://Vandit1604.github.io/jenkins.io/independent-scrolling-patch/blog/2016/08/10/rails-cd-with-pipeline/" property="og:url">
<meta content="Jenkins – an open source automation server which enables developers around the world to reliably build, test, and deploy their software" name="og:description">
<meta content="Continuous Security for Rails apps with Pipeline and Brakeman" property="og:site_name">
<meta content="/jenkins.io/independent-scrolling-patch/images/logo-title-opengraph.png" name="og:image">
<link href="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/jenkins.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/stylesheets/styles.css" media="screen" rel="stylesheet">
<!-- Non-obtrusive CSS styles -->
<link href="/jenkins.io/independent-scrolling-patch/css/footer.css" media="screen" rel="stylesheet">
<link href="/jenkins.io/independent-scrolling-patch/css/font-awesome.min.css" media="screen" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" rel="stylesheet">
</head>
<body>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/jquery/jquery.min.js"></script>
<!-- starting partial toptoolbar.html.haml -->
<jio-navbar class="fixed-top" id="ji-toolbar" property="https://www.jenkins.io" showSearchBox=""></jio-navbar>
<!-- Spacing to make the fixed-top sticky navbar not occlude any content below it -->
<div class="pt-4">
&nbsp;
</div>

<!-- ending partial toptoolbar.html.haml -->
<!-- starting partial anchors.html.haml -->
<script>
  window.addEventListener('DOMContentLoaded', function () {
    for (var i = 1 ; i <= 6 ; i ++) {
      anchors.add('.app-post-page h' + i);
    }
  })
</script>

<!-- ending partial anchors.html.haml -->
<article class="container app-post-page">
<div class="app-!-display-flex">
<a class="app-back-link" href="/jenkins.io/independent-scrolling-patch/node/">
Back to blog
</a>
</div>
<h1>
Continuous Security for Rails apps with Pipeline and Brakeman
</h1>
<div class="post-attrs">
<a class="app-author-link" href="/blog/authors/rtyler/"><div class="app-avatar"><img alt="R. Tyler Croy" class="app-avatar__image" src="/images/avatars/rtyler.jpeg"></div> R. Tyler Croy</a>
August 10, 2016
<a class="twitter-share-button" data-lang="en" href="https://twitter.com/intent/tweet?text=Continuous+Security+for+Rails+apps+with+Pipeline+and+Brakeman&amp;url=https%3A%2F%2Fwww.jenkins.io%2Fjenkins.io%2Findependent-scrolling-patch%2Fblog%2F2016%2F08%2F10%2Frails-cd-with-pipeline%2F" rel="noreferrer nofollow" target="_blank">
Tweet
</a>
</div>
<div class="blog-content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is a guest post by <a href="https://github.com/rtyler">R. Tyler Croy</a>, who is a
long-time contributor to Jenkins and the primary contact for Jenkins project
infrastructure. He is also a Jenkins Evangelist at
<a href="https://cloudbees.com">CloudBees, Inc.</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the <a href="https://rubyonrails.org">Ruby on Rails</a> framework debuted it
changed the industry in two noteworthy ways: it created a trend of opinionated web
application frameworks (<a href="https://www.djangoproject.com/">Django</a>,
<a href="https://playframework.com/">Play</a>, <a href="https://grails.org/">Grails</a>) and it
also <em>strongly</em> encouraged thousands of developers to embrace test-driven
development along with many other modern best practices (source control, dependency
management, etc). Because Ruby, the language underneath Rails, is interpreted
instead of compiled there isn&#8217;t a "build" per se but rather tens, if not
hundreds, of tests, linters and scans which are run to ensure the application&#8217;s
quality. With the rise in popularity of Rails, the popularity of application
hosting services with easy-to-use deployment tools like <a href="https://heroku.com">Heroku</a> or
<a href="https://engineyard.com">Engine Yard</a> rose too.</p>
</div>
<div class="paragraph">
<p>This combination of good <strong>test coverage</strong> and easily <strong>automated deployments</strong>
makes Rails easy to continuously deliver with Jenkins. In this post we&#8217;ll cover
testing non-trivial Rails applications with <a href="/doc/pipeline">Jenkins
Pipeline</a> and, as an added bonus, we will add security scanning via
<a href="https://brakemanscanner.org">Brakeman</a> and the
<a href="https://wiki.jenkins.io/display/JENKINS/Brakeman+Plugin">Brakeman
plugin</a>.</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/ruby-pipeline-2016/cfpapp-stage-view.png" alt="cfpapp stage view">
</div>
</div>
<div class="paragraph">
<p><strong>Topics</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#preparing-the-app">Preparing the app</a></p>
</li>
<li>
<p><a href="#preparing-jenkins">Preparing Jenkins</a></p>
</li>
<li>
<p><a href="#writing-the-pipeline">Writing the Pipeline</a></p>
</li>
<li>
<p><a href="#security-scanning">Security scanning</a></p>
</li>
<li>
<p><a href="#deploying-the-good-stuff">Deploying the good stuff</a></p>
</li>
<li>
<p><a href="#wrap-up">Wrap up</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this demonstration, I used <a href="https://rubycentral.org/">Ruby Central</a>'s
<a href="https://github.com/rubycentral/cfp-app">cfp-app</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A Ruby on Rails application that lets you manage your conference&#8217;s call for
proposal (CFP), program and schedule. It was written by Ruby Central to run the
CFPs for RailsConf and RubyConf.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>I chose this Rails app, not only because it&#8217;s a sizable application with lots
of tests, but it&#8217;s actually the application we used to collect talk proposals
for the "Community Tracks" at this
year&#8217;s <a href="https://jenkinsworld.com">Jenkins World</a>. For the most part,
cfp-app is a standard Rails application. It uses
<a href="https://www.postgresql.org/">PostgreSQL</a> for its database,
<a href="https://rspec.info">RSpec</a> for its tests and
<a href="https://ruby-lang.org">Ruby 2.3.x</a> as its runtime.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you prefer to just to look at the code, skip straight to the
<a href="https://github.com/rtyler/cfp-app/blob/aff11d97b460ca4b630b1fa4f669c226aeadd8ae/Jenkinsfile">Jenkinsfile</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="preparing-the-app"><a class="anchor" href="#preparing-the-app"></a>Preparing the app</h3>
<div class="paragraph">
<p>For <em>most</em> Rails applications there are few, if any, changes needed to enable
continuous delivery with Jenkins. In the case of
<a href="https://github.com/rubycentral/cfp-app">cfp-app</a>, I added two gems to get
the most optimal integration into Jenkins:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://github.com/ci-reporter/ci_reporter">ci_reporter</a>, for test report
integration</p>
</li>
<li>
<p><a href="https://github.com/presidentbeef/brakeman">brakeman</a>, for security scanning.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Adding these was simple, I just needed to update the <code>Gemfile</code> and the
<code>Rakefile</code> in the root of the repository to contain:</p>
</div>
<div class="listingblock">
<div class="title">Gemfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="ruby"><span class="c1"># .. snip ..</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># RSpec, etc</span>
  <span class="n">gem</span> <span class="s1">'ci_reporter'</span>
  <span class="n">gem</span> <span class="s1">'ci_reporter_rspec'</span>
  <span class="n">gem</span> <span class="s2">"brakeman"</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
<span class="k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Rakefile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="ruby"><span class="c1"># .. snip ..</span>
<span class="nb">require</span> <span class="s1">'ci/reporter/rake/rspec'</span>
<span class="c1"># Make sure we setup ci_reporter before executing our RSpec examples</span>
<span class="n">task</span> <span class="ss">:spec</span> <span class="o">=&gt;</span> <span class="s1">'ci:setup:rspec'</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preparing-jenkins"><a class="anchor" href="#preparing-jenkins"></a>Preparing Jenkins</h3>
<div id="plugins" class="paragraph">
<p>With the cfp-app project set up, next on the list is to ensure that Jenkins itself
is ready. Generally I suggest running the <a href="/changelog-stable">latest LTS</a> of
Jenkins; for this demonstration I used Jenkins 2.7.1 with the following
plugins:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.jenkins.io/display/JENKINS/Pipeline+Plugin">Pipeline plugin</a></p>
</li>
<li>
<p><a href="https://wiki.jenkins.io/display/JENKINS/Brakeman+Plugin">Brakeman plugin</a></p>
</li>
<li>
<p><a href="https://wiki.jenkins.io/display/JENKINS/CloudBees+Docker+Pipeline+Plugin">CloudBees
Docker Pipeline plugin</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I also used the
<a href="https://wiki.jenkins.io/display/JENKINS/GitHub+Organization+Folder+Plugin">GitHub
Organization Folder plugin</a> to automatically create pipeline items in my
Jenkins instance; that isn&#8217;t required for the demo, but it&#8217;s pretty cool to see
repositories and branches with a <code>Jenkinsfile</code> automatically show up in
Jenkins, so I recommend it!</p>
</div>
<div class="paragraph">
<p>In addition to the <a href="#plugins">plugins</a> listed above, I also needed at least <em>one</em>
Jenkins agent with the <a href="https://docker.io">Docker</a> daemon installed and
running on it. I label these agents with "docker" to make it easier to assign
Docker-based workloads to them in the future.</p>
</div>
<div class="paragraph">
<p>Any Linux-based machine with Docker installed will work, in my case I was
provisioning on-demand agents with the
<a href="https://wiki.jenkins.io/display/JENKINS/Azure+Slave+plugin">Azure
plugin</a> which, like the
<a href="https://wiki.jenkins.io/display/JENKINS/Amazon+EC2+Plugin">EC2 plugin</a>,
helps keep my test costs down.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re using Amazon Web Services, you might also be interested in
<a href="/blog/2016/06/10/save-costs-with-ec2-spot-fleet">this blog post</a> from
earlier this year unveiling the
<a href="https://wiki.jenkins.io/display/JENKINS/Amazon+EC2+Fleet+Plugin">EC2
Fleet plugin</a> for working with EC2 Spot Fleets.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="writing-the-pipeline"><a class="anchor" href="#writing-the-pipeline"></a>Writing the Pipeline</h3>
<div class="paragraph">
<p>To make sense of the various things that the <code>Jenkinsfile</code> needs to do, I find
it easier to start by simply defining the stages of my pipeline. This helps me
think of, in broad terms, what order of operations my pipeline should have.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="cm">/* Assign our work to an agent labelled 'docker' */</span>
<span class="n">node</span><span class="o">(</span><span class="s1">'docker'</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">stage</span> <span class="s1">'Prepare Container'</span>
    <span class="n">stage</span> <span class="s1">'Install Gems'</span>
    <span class="n">stage</span> <span class="s1">'Prepare Database'</span>
    <span class="n">stage</span> <span class="s1">'Invoke Rake'</span>
    <span class="n">stage</span> <span class="s1">'Security scan'</span>
    <span class="n">stage</span> <span class="s1">'Deploy'</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned previously, this <code>Jenkinsfile</code> is going to rely heavily on the
<a href="https://wiki.jenkins.io/display/JENKINS/CloudBees+Docker+Pipeline+Plugin">CloudBees
Docker Pipeline plugin</a>. The plugin provides two very important features:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ability to execute steps <em>inside</em> of a running Docker container</p>
</li>
<li>
<p>Ability to run a container in the "background."</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Like most Rails applications, one can effectively test the application with two
commands: <code>bundle install</code> followed by <code>bundle exec rake</code>. I already had some
Docker images prepared with <a href="https://rvm.io">RVM</a> and Ruby 2.3.0 installed,
which ensures a common and consistent starting point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span><span class="o">(</span><span class="s1">'docker'</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// .. 'stage' steps removed</span>
    <span class="n">docker</span><span class="o">.</span><span class="na">image</span><span class="o">(</span><span class="s1">'rtyler/rvm:2.3.0'</span><span class="o">).</span><span class="na">inside</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="n">rvm</span> <span class="s1">'bundle install'</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="n">rvm</span> <span class="s1">'bundle exec rake'</span>
    <span class="o">}</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Run the named container. The <code>inside</code> method can take optional additional flags for the <code>docker run</code> command.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Execute our shell commands using our tiny <code>sh</code> step wrapper
<a href="https://github.com/rtyler/cfp-app/blob/aff11d97b460ca4b630b1fa4f669c226aeadd8ae/Jenkinsfile#L86-L91"><code>rvm</code></a>. This ensures that the shell code is executed in the correct RVM environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When the closure completes, the container will be destroyed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unfortunately, with this application, the <code>bundle exec rake</code> command will fail
if PostgreSQL isn&#8217;t available when the process starts. This is where the
<em>second</em> important feature of the CloudBees Docker Pipeline plugin comes
into effect: the ability to run a container in the "background."</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span><span class="o">(</span><span class="s1">'docker'</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// .. 'stage' steps removed</span>
    <span class="cm">/* Pull the latest `postgres` container and run it in the background */</span>
    <span class="n">docker</span><span class="o">.</span><span class="na">image</span><span class="o">(</span><span class="s1">'postgres'</span><span class="o">).</span><span class="na">withRun</span> <span class="o">{</span> <span class="n">container</span> <span class="o">-&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="n">echo</span> <span class="s2">"PostgreSQL running in container ${container.id}"</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="o">}</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Run the container, effectively <code>docker run postgres</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Any number of steps can go inside the closure</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When the closure completes, the container will be destroyed.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="running-the-tests"><a class="anchor" href="#running-the-tests"></a>Running the tests</h4>
<div class="paragraph">
<p>Combining these two snippets of Jenkins Pipeline is, in my opinion, where the
power of the <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a>
shines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span><span class="o">(</span><span class="s1">'docker'</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">docker</span><span class="o">.</span><span class="na">image</span><span class="o">(</span><span class="s1">'postgres'</span><span class="o">).</span><span class="na">withRun</span> <span class="o">{</span> <span class="n">container</span> <span class="o">-&gt;</span>
        <span class="n">docker</span><span class="o">.</span><span class="na">image</span><span class="o">(</span><span class="s1">'rtyler/rvm:2.3.0'</span><span class="o">).</span><span class="na">inside</span><span class="o">(</span><span class="s2">"--link=${container.id}:postgres"</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="n">stage</span> <span class="s1">'Install Gems'</span>
            <span class="n">rvm</span> <span class="s2">"bundle install"</span>

            <span class="n">stage</span> <span class="s1">'Invoke Rake'</span>
            <span class="n">withEnv</span><span class="o">([</span><span class="s1">'DATABASE_URL=postgres://postgres@postgres:5432/'</span><span class="o">])</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="n">rvm</span> <span class="s2">"bundle exec rake"</span>
            <span class="o">}</span>
            <span class="n">junit</span> <span class="s1">'spec/reports/*.xml'</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>By passing the <code>--link</code> argument, the Docker daemon will allow the RVM container to talk to the PostgreSQL container under the host name 'postgres'.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the <code>withEnv</code> step to set environment variables for everything that is in the closure. In this case, the cfp-app DB scaffolding will look for the <code>DATABASE_URL</code> variable to override the DB host/user/dbname defaults.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Archive the test reports generated by <a href="https://github.com/ci-reporter/ci_reporter">ci_reporter</a> so that Jenkins can display test reports and trend analysis.</td>
</tr>
</table>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/ruby-pipeline-2016/cfpapp-tests.png" alt="cfpapp tests">
</div>
</div>
<div class="paragraph">
<p>With this done, the basics are in place to consistently run the tests for
cfp-app in fresh Docker containers for each execution of the pipeline.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-scanning"><a class="anchor" href="#security-scanning"></a>Security scanning</h3>
<div class="paragraph">
<p>Using <a href="https://brakemanscanner.org">Brakeman</a>, the security scanner for Ruby
on Rails, is almost trivially easy inside of Jenkins Pipeline, thanks to the
<a href="https://wiki.jenkins.io/display/JENKINS/Brakeman+Plugin">Brakeman
plugin</a> which implements the <code>publishBrakeman</code> step.</p>
</div>
<div class="paragraph">
<p>Building off our example above, we can implement the "Security scan" stage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span><span class="o">(</span><span class="s1">'docker'</span><span class="o">)</span> <span class="o">{</span>
    <span class="cm">/* --8&lt;--8&lt;-- snipsnip --8&lt;--8&lt;-- */</span>
    <span class="n">stage</span> <span class="s1">'Security scan'</span>
    <span class="n">rvm</span> <span class="s1">'brakeman -o brakeman-output.tabs --no-progress --separate-models'</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="n">publishBrakeman</span> <span class="s1">'brakeman-output.tabs'</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="cm">/* --8&lt;--8&lt;-- snipsnip --8&lt;--8&lt;-- */</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Run the <a href="https://brakemanscanner.org">Brakeman</a> security scanner for Rails and store the output for later in <code>brakeman-output.tabs</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Archive the reports generated by Brakeman so that Jenkins can display detailed reports with trend analysis.</td>
</tr>
</table>
</div>
<div class="imageblock center">
<div class="content">
<img src="/images/post-images/ruby-pipeline-2016/cfpapp-brakeman.png" alt="cfpapp brakeman">
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of this writing, there is work in progress
(<a href="https://issues.jenkins.io/browse/JENKINS-31202">JENKINS-31202</a>) to
render trend graphs from plugins like Brakeman on a pipeline project&#8217;s main
page.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="deploying-the-good-stuff"><a class="anchor" href="#deploying-the-good-stuff"></a>Deploying the good stuff</h3>
<div class="paragraph">
<p>Once the tests and security scanning are all working properly, we can start to
set up the deployment stage. Jenkins Pipeline provides the variable
<code>currentBuild</code> which we can use to determine whether our pipeline has been
successful thus far or not. This allows us to add the logic to only deploy when
everything is passing, as we would expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="groovy"><span class="n">node</span><span class="o">(</span><span class="s1">'docker'</span><span class="o">)</span> <span class="o">{</span>
    <span class="cm">/* --8&lt;--8&lt;-- snipsnip --8&lt;--8&lt;-- */</span>
    <span class="n">stage</span> <span class="s1">'Deploy'</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">currentBuild</span><span class="o">.</span><span class="na">result</span> <span class="o">==</span> <span class="s1">'SUCCESS'</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="n">sh</span> <span class="s1">'./deploy.sh'</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="n">mail</span> <span class="nl">subject:</span> <span class="s2">"Something is wrong with ${env.JOB_NAME} ${env.BUILD_ID}"</span><span class="o">,</span>
                  <span class="nl">to:</span> <span class="s1">'nobody@example.com'</span><span class="o">,</span>
                <span class="nl">body:</span> <span class="s1">'You should fix it'</span>
    <span class="o">}</span>
    <span class="cm">/* --8&lt;--8&lt;-- snipsnip --8&lt;--8&lt;-- */</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>currentBuild</code> has the <code>result</code> property which would be <code>'SUCCESS'</code>, <code>'FAILED'</code>, <code>'UNSTABLE'</code>, <code>'ABORTED'</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Only if <code>currentBuild.result</code> is successful should we bother invoking our deployment script (e.g. <code>git push heroku master</code>)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="wrap-up"><a class="anchor" href="#wrap-up"></a>Wrap up</h3>
<div class="paragraph">
<p>I have gratuitously commented the full
<a href="https://github.com/rtyler/cfp-app/blob/0e85db6d054deefd637de235766468631f551c7f/Jenkinsfile">Jenkinsfile</a>
which I hope is a useful summation of the work outlined above. Having worked
on a number of Rails applications in the past, the consistency provided by
Docker and Jenkins Pipeline above would have definitely improved those
projects' delivery times. There is still room for improvement however, which
is left as an exercise for the reader. Such as: preparing new containers with
all their
<a href="https://github.com/rtyler/cfp-app/blob/0e85db6d054deefd637de235766468631f551c7f/Jenkinsfile#L36-L46">dependencies
built-in</a> instead of installing them at run-time. Or utilizing the <code>parallel</code>
step for executing RSpec across multiple Jenkins agents simultaneously.</p>
</div>
<div class="paragraph">
<p>The beautiful thing about defining your continuous delivery, and continuous
security, pipeline in code is that you can continue to iterate on it!</p>
</div>
<div class="imageblock center">
<div class="content">
<a class="image" href="https://github.com/rtyler/cfp-app/blob/0e85db6d054deefd637de235766468631f551c7f/Jenkinsfile"><img src="/images/post-images/ruby-pipeline-2016/cfpapp-stage-view.png" alt="cfpapp stage view"></a>
</div>
</div>
</div>
</div>
<ul class="app-tags">
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/tutorial/">
tutorial
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/ruby/">
ruby
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/pipeline/">
pipeline
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/rails/">
rails
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/brakeman/">
brakeman
</a>
</li>
<li>
<a class="app-tags__tag" href="/jenkins.io/independent-scrolling-patch/node/tags/continuousdelivery/">
continuousdelivery
</a>
</li>
</ul>
<h2>
About the author
</h2>
<!-- starting partial author.html.haml -->
<div class="app-author" id="about-the-author">
<!-- starting partial avatar.html.haml -->
<div class="app-avatar" style="min-width: 64px; width: 25vw; max-width: 128px">
<img alt="R. Tyler Croy" class="app-avatar__image" src="/jenkins.io/independent-scrolling-patch/images/avatars/rtyler.jpeg">
</div>

<!-- ending partial avatar.html.haml -->
<div class="app-author__content">
<p class="app-author__name">
<a href="/blog/authors/rtyler/">
R. Tyler Croy
</a>
</p>
<div class="paragraph">
<p>R&#46; Tyler Croy has been part of the Jenkins project for the past seven years.
While avoiding contributing any Java code, Tyler is involved in many of the
other aspects of the project which keep it running, such as this website,
infrastructure, governance, etc.</p>
</div>
<!-- starting partial social-media-buttons.html.haml -->
<ul class="app-social-media-buttons">
<li>
<a href="https://github.com/rtyler" rel="noreferrer noopener" target="_blank">
GitHub
</a>
</li>
<li>
<a href="https://twitter.com/agentdero" rel="noreferrer noopener" target="_blank">
Twitter
</a>
</li>
<li>
<a href="http://unethicalblogger.com" rel="noreferrer noopener" target="_blank">
Blog
</a>
</li>
</ul>

<!-- ending partial social-media-buttons.html.haml -->
</div>
</div>

<!-- ending partial author.html.haml -->
<!-- starting partial discuss.html.haml -->

<!-- ending partial discuss.html.haml -->
</article>


<script src="/jenkins.io/independent-scrolling-patch/assets/bower/anchor-js/anchor.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/@popperjs/core/umd/popper.min.js"></script>
<script src="/jenkins.io/independent-scrolling-patch/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lit@2.5.0/polyfill-support.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.6.0/webcomponents-loader.js"></script>
<script data="ionicons" defer="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.esm.js" type="module"></script>
<script data="ionicons" defer="" nomodule="" src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/5.5.2/ionicons/ionicons.js"></script>
<script defer="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/+esm" type="module"></script>
<script defer="" nomodule="" src="https://cdn.jsdelivr.net/npm/@jenkinsci/jenkins-io-components/"></script>
<jio-footer githubBranch="master" githubRepo="jenkins-infra/jenkins.io" property="https://www.jenkins.io" sourcePath="content//blog/2016/2016-08-10-rails-cd-with-pipeline.adoc"></jio-footer>
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-000000-0', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  $(function(){
    var $body = $(document.body);
    $body.on("keydown", function(){
      $body.removeClass("no-outline");
    })
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3" type="text/javascript"></script>
<script type="text/javascript">
docsearch({
  container: document.querySelector('input.searchbox').parentNode,
  indexName: 'jenkins',
  appId: "M6L7Q4Z8HS",
  apiKey: "52f8dfbff76ffd9106f1c68fee16154b",
  algoliaOptions: { 'facetFilters': ["tags:en"] },
  debug: false
});
</script>
</body>
</html>
